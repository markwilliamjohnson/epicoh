<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DR Startup Goguen Explorer — Real-time Monte Carlo Simulator</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --panel2:#0f1730; --text:#e8ecff;
      --muted:#aab4e6; --accent:#7aa2ff; --accent2:#61e6c6; --warn:#ffcc66; --bad:#ff6b7a;
      --good:#6ef08d; --line:#243058;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:linear-gradient(180deg,#070b17, var(--bg));color:var(--text)}
    header{
      padding:18px 18px 10px;border-bottom:1px solid var(--line);
      background:rgba(18,26,51,.55);backdrop-filter: blur(8px);
      position:sticky;top:0;z-index:5
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    main{display:grid;grid-template-columns: 440px 1fr;gap:14px;padding:14px;max-width:1400px;margin:0 auto}
    .card{background:rgba(18,26,51,.72);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .card h2{
      margin:0;padding:12px 14px;border-bottom:1px solid var(--line);
      font-size:14px;color:var(--text);display:flex;align-items:center;justify-content:space-between
    }
    .card h2 small{color:var(--muted);font-weight:500}
    .card .content{padding:12px 14px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="range"]{width:100%}
    .metric{font-family:var(--mono);font-size:12px;color:var(--text)}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(10,14,30,.55);color:var(--muted);font-size:12px}
    .btns{display:flex;flex-wrap:wrap;gap:8px}
    button{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(122,162,255,.25), rgba(122,162,255,.12));
      color:var(--text);
      padding:9px 10px;border-radius:10px;
      cursor:pointer;font-size:12px;
    }
    button.secondary{
      background:linear-gradient(180deg, rgba(97,230,198,.25), rgba(97,230,198,.12));
    }
    button.ghost{background:transparent;}
    button:active{transform:translateY(1px)}
    .note{font-size:12px;color:var(--muted);line-height:1.45;margin-top:10px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .charts{display:grid;grid-template-columns: 1fr 380px;gap:14px}
    canvas{width:100%;height:280px;background:rgba(8,12,24,.35);border:1px solid var(--line);border-radius:12px}
    .smallCanvas{height:230px}
    select, textarea, input[type="text"]{
      width:100%;
      border-radius:10px;border:1px solid var(--line);
      background:rgba(8,12,24,.55);
      color:var(--text);
      padding:8px 10px;font-size:12px;outline:none;
    }
    textarea{min-height:120px;resize:vertical;font-family:var(--mono)}
    .explain{
      background:rgba(8,12,24,.35);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .explain b{color:var(--text)}
    .kpi{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .kpi .box{
      background:rgba(8,12,24,.35);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
    }
    .kpi .val{font-family:var(--mono);font-size:18px;margin-top:6px}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .mono{font-family:var(--mono)}
    .plan{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:rgba(8,12,24,.35);
      margin-top:10px;
    }
    .plan h3{margin:0 0 6px 0;font-size:12px;color:var(--text)}
    .plan ul{margin:6px 0 0 18px;color:var(--muted);font-size:12px;line-height:1.4}
    .footer{padding:12px 14px;border-top:1px solid var(--line);color:var(--muted);font-size:11px;line-height:1.4}
    .statusRow{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}
    .statusDot{width:10px;height:10px;border-radius:99px;background:rgba(255,204,102,.9);box-shadow:0 0 0 3px rgba(255,204,102,.15)}
    .statusText{font-size:12px;color:var(--muted)}
    @media (max-width: 1040px){
      main{grid-template-columns: 1fr}
      .charts{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
<header>
  <h1>DR Startup Goguen Explorer — Real-time Outcome Simulator (Monte Carlo)</h1>
  <div class="sub">
    Move sliders to explore key parameters implied by the Goguen/institution model. Histograms update in real time (fast mode while dragging),
    then refine automatically (full runs) when you pause.
  </div>
</header>

<main>
  <!-- LEFT: PARAMETERS -->
  <section class="card">
    <h2>Parameters <small>0–100 (higher = more of the thing)</small></h2>
    <div class="content">

      <div class="grid2">
        <div>
          <label>Runway / cash buffer (months proxy)</label>
          <input id="p_runway" type="range" min="0" max="100" value="10"/>
          <div class="row"><span class="pill">Runway</span><span id="v_runway" class="metric"></span></div>
        </div>
        <div>
          <label>Governance quality (controls & alignment)</label>
          <input id="p_gov" type="range" min="0" max="100" value="25"/>
          <div class="row"><span class="pill">Governance</span><span id="v_gov" class="metric"></span></div>
        </div>

        <div>
          <label>Team morale / cohesion</label>
          <input id="p_morale" type="range" min="0" max="100" value="35"/>
          <div class="row"><span class="pill">Morale</span><span id="v_morale" class="metric"></span></div>
        </div>
        <div>
          <label>Innovation embedded + documented (transferability)</label>
          <input id="p_transfer" type="range" min="0" max="100" value="20"/>
          <div class="row"><span class="pill">Transferability</span><span id="v_transfer" class="metric"></span></div>
        </div>

        <div>
          <label>Build reproducibility (rebuild/run reliably)</label>
          <input id="p_repro" type="range" min="0" max="100" value="30"/>
          <div class="row"><span class="pill">Repro build</span><span id="v_repro" class="metric"></span></div>
        </div>
        <div>
          <label>IP / data rights clarity</label>
          <input id="p_ip" type="range" min="0" max="100" value="40"/>
          <div class="row"><span class="pill">Clean IP</span><span id="v_ip" class="metric"></span></div>
        </div>

        <div>
          <label>Clinical trial completion</label>
          <input id="p_trial" type="range" min="0" max="100" value="30"/>
          <div class="row"><span class="pill">Trials</span><span id="v_trial" class="metric"></span></div>
        </div>
        <div>
          <label>Accuracy confidence (credibility)</label>
          <input id="p_acc" type="range" min="0" max="100" value="35"/>
          <div class="row"><span class="pill">Accuracy</span><span id="v_acc" class="metric"></span></div>
        </div>

        <div>
          <label>MHRA readiness (QMS/evidence/reg plan)</label>
          <input id="p_mhra" type="range" min="0" max="100" value="15"/>
          <div class="row"><span class="pill">MHRA</span><span id="v_mhra" class="metric"></span></div>
        </div>
        <div>
          <label>Concept strength (HMI/teaching value)</label>
          <input id="p_concept" type="range" min="0" max="100" value="75"/>
          <div class="row"><span class="pill">Concept</span><span id="v_concept" class="metric"></span></div>
        </div>

        <div>
          <label>User workflow pressure (time poverty)</label>
          <input id="p_pressure" type="range" min="0" max="100" value="85"/>
          <div class="row"><span class="pill">Pressure</span><span id="v_pressure" class="metric"></span></div>
        </div>
        <div>
          <label>Integration friction (IT/workflow disruption)</label>
          <input id="p_integr" type="range" min="0" max="100" value="70"/>
          <div class="row"><span class="pill">Friction</span><span id="v_integr" class="metric"></span></div>
        </div>

        <div>
          <label>Time-saving wedge power (onboarding/QA)</label>
          <input id="p_timesave" type="range" min="0" max="100" value="45"/>
          <div class="row"><span class="pill">Time save</span><span id="v_timesave" class="metric"></span></div>
        </div>
        <div>
          <label>Minimal-integration packaging (CSV/web)</label>
          <input id="p_minint" type="range" min="0" max="100" value="55"/>
          <div class="row"><span class="pill">Min integ</span><span id="v_minint" class="metric"></span></div>
        </div>

        <div>
          <label>GPU / hosting cost pressure</label>
          <input id="p_gpu" type="range" min="0" max="100" value="70"/>
          <div class="row"><span class="pill">GPU cost</span><span id="v_gpu" class="metric"></span></div>
        </div>
        <div>
          <label>“Build it and they will come” is false</label>
          <input id="p_buildfalse" type="range" min="0" max="100" value="80"/>
          <div class="row"><span class="pill">Build-it-false</span><span id="v_buildfalse" class="metric"></span></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div style="flex:1">
          <label>Monte Carlo runs (refine when you pause)</label>
          <input id="p_runs" type="range" min="200" max="20000" value="5000"/>
          <div class="row"><span class="pill">Runs</span><span id="v_runs" class="metric"></span></div>
        </div>
        <div style="flex:1">
          <label>Noise level (uncertainty)</label>
          <input id="p_noise" type="range" min="0" max="100" value="30"/>
          <div class="row"><span class="pill">Noise</span><span id="v_noise" class="metric"></span></div>
        </div>
      </div>

      <div class="statusRow">
        <div style="display:flex;gap:8px;align-items:center">
          <div id="statusDot" class="statusDot"></div>
          <div id="statusText" class="statusText">Real-time update: ready</div>
        </div>
        <div class="btns">
          <button id="btnSuggest" class="secondary">Suggest best options</button>
          <button id="btnReset" class="ghost">Reset baseline</button>
        </div>
      </div>

      <div class="note">
        <b>Real-time mode:</b> while you drag a slider the sim uses a fast run-count for responsiveness, then automatically refines after you stop.
      </div>
    </div>

    <div class="footer">
      This is a transparent approximation inspired by the formal constraints of the Goguen model (barriers, entailments, and feasibility).
      It is not medical, legal, or financial advice.
    </div>
  </section>

  <!-- RIGHT: OUTPUTS -->
  <section class="card">
    <h2>Outcomes <small>Probabilities & distributions</small></h2>
    <div class="content">

      <div class="kpi">
        <div class="box">
          <div class="mono">Best near-term path</div>
          <div id="bestPath" class="val good">—</div>
          <div id="bestPathNote" class="note"></div>
        </div>
        <div class="box">
          <div class="mono">Primary blocker</div>
          <div id="blocker" class="val warn">—</div>
          <div id="blockerNote" class="note"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="charts">
        <div>
          <label style="font-size:13px;color:var(--text)">Outcome probabilities (mean)</label>
          <canvas id="barChart" width="980" height="380"></canvas>

          <div class="row" style="margin-top:12px">
            <div style="flex:1">
              <label style="font-size:13px;color:var(--text)">Distribution for outcome</label>
              <select id="distSelect"></select>
            </div>
            <div style="width:170px">
              <label style="font-size:13px;color:var(--text)">Histogram bins</label>
              <input id="p_bins" type="range" min="6" max="40" value="20"/>
              <div class="row"><span class="pill">Bins</span><span id="v_bins" class="metric"></span></div>
            </div>
          </div>

          <canvas id="histChart" class="smallCanvas" width="980" height="320" style="margin-top:12px"></canvas>
        </div>

        <div>
          <label style="font-size:13px;color:var(--text)">Why these outcomes?</label>
          <div id="explainBox" class="explain">Move sliders to update outcomes and explanations in real time.</div>

          <div class="divider"></div>

          <label style="font-size:13px;color:var(--text)">AI prompt generator — imaginary case study</label>
          <textarea id="caseInput" placeholder="Add specifics about your situation or a proposed move:
- Which buyer type you’re targeting
- Biggest constraint
- Proposed wedge pilot
- Evidence plan / governance reset
- What you want the case study to focus on"></textarea>

          <div class="row" style="margin-top:8px;gap:8px">
            <input id="promptTitle" type="text" placeholder="Case-study angle (e.g., “Education wedge pilot for grader onboarding”)"/>
          </div>

          <div class="btns" style="margin-top:8px">
            <button id="btnPrompt" class="secondary">Generate AI prompt</button>
            <button id="btnCopy" class="ghost">Copy prompt</button>
          </div>

          <label style="margin-top:10px;font-size:13px;color:var(--text)">Generated prompt</label>
          <textarea id="promptOut" readonly></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <label style="font-size:13px;color:var(--text)">Suggested plans (best options search)</label>
      <div id="plans"></div>

    </div>
  </section>
</main>

<script>
/* ============================================================
   Real-time Monte Carlo Goguen Explorer (no React)
   - Histograms update in real-time on slider movement
   - Uses fast simulation while dragging, then refines when idle
   - Larger chart legends and labels for readability
   ============================================================ */

/** ---------- Helpers ---------- */
const clamp01 = x => Math.max(0, Math.min(1, x));
const to01 = v => clamp01(v / 100);
const sigmoid = x => 1 / (1 + Math.exp(-x));
function randn() { // Box–Muller
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}
const fmtPct = x => (100*x).toFixed(1) + "%";
const fmt01 = x => x.toFixed(2);
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/** ---------- Outcomes ---------- */
const OUTCOMES = [
  { key:"eduPilot",  label:"Education/QA pilot succeeds" },
  { key:"diagPath",  label:"Diagnostic pathway feasible soon" },
  { key:"buyout",    label:"Buyout worthwhile (whole company)" },
  { key:"assetBuy",  label:"Asset purchase into NewCo is best" },
  { key:"restart",   label:"Restart from scratch is better" },
  { key:"freeWeb",   label:"Free web service yields traction" }
];

const distSelect = document.getElementById("distSelect");
OUTCOMES.forEach(o=>{
  const opt = document.createElement("option");
  opt.value = o.key;
  opt.textContent = o.label;
  distSelect.appendChild(opt);
});

/** ---------- Slider wiring ---------- */
const sliderIds = [
  "runway","gov","morale","transfer","repro","ip","trial","acc","mhra","concept",
  "pressure","integr","timesave","minint","gpu","buildfalse","runs","noise","bins"
];

function getParam(id){ return Number(document.getElementById("p_"+id).value); }
function setParam(id,val){ document.getElementById("p_"+id).value = val; }
function updateReadouts(){
  sliderIds.forEach(id=>{
    const out = document.getElementById("v_"+id);
    if(out) out.textContent = getParam(id).toString();
  });
}
updateReadouts();

/** ---------- Status indicator ---------- */
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
function setStatus(mode){
  // mode: "fast" | "refine" | "ready"
  if(mode==="fast"){
    statusDot.style.background = "rgba(255,204,102,.95)";
    statusDot.style.boxShadow = "0 0 0 3px rgba(255,204,102,.15)";
    statusText.textContent = "Real-time update: fast mode (dragging)";
  } else if(mode==="refine"){
    statusDot.style.background = "rgba(122,162,255,.95)";
    statusDot.style.boxShadow = "0 0 0 3px rgba(122,162,255,.15)";
    statusText.textContent = "Real-time update: refining (full runs)";
  } else {
    statusDot.style.background = "rgba(97,230,198,.95)";
    statusDot.style.boxShadow = "0 0 0 3px rgba(97,230,198,.15)";
    statusText.textContent = "Real-time update: ready";
  }
}

/** ---------- Core model (institution-inspired) ---------- */
function computeDeterministicScores(p){
  const runway   = to01(p.runway);
  const gov      = to01(p.gov);
  const morale   = to01(p.morale);
  const transfer = to01(p.transfer);
  const repro    = to01(p.repro);
  const ip       = to01(p.ip);
  const trial    = to01(p.trial);
  const acc      = to01(p.acc);
  const mhra     = to01(p.mhra);
  const concept  = to01(p.concept);
  const pressure = to01(p.pressure);
  const integr   = to01(p.integr);
  const timesave = to01(p.timesave);
  const minint   = to01(p.minint);
  const gpu      = to01(p.gpu);
  const buildfalse = to01(p.buildfalse);

  const governanceFailure = 1 - gov;
  const evidenceStrength = 0.55*trial + 0.45*acc;
  const diagnosticReadiness = 0.45*mhra + 0.35*evidenceStrength + 0.20*repro;
  const adoptionFriction = 0.55*pressure + 0.45*integr;
  const wedgePower = 0.55*timesave + 0.45*minint;
  const coreAssets = 0.34*ip + 0.33*repro + 0.33*transfer;

  const sEdu =
      2.2*(concept-0.5) +
      2.4*(wedgePower-0.5) +
      1.2*(gov-0.5) +
      1.0*(morale-0.5) +
      0.8*(runway-0.5) -
      2.2*(adoptionFriction-0.5);

  const sDiag =
      3.2*(diagnosticReadiness-0.55) +
      1.6*(runway-0.5) +
      0.8*(morale-0.5) -
      1.2*(governanceFailure-0.5) -
      1.2*(integr-0.5) -
      0.9*(pressure-0.5);

  const sBuyout =
      3.1*(coreAssets-0.55) +
      1.6*(sigmoid(sEdu)-0.5) +
      0.8*(morale-0.5) -
      2.0*(governanceFailure-0.5) -
      1.2*( (0.45*(1-runway) + 0.55*gpu) - 0.5 );

  const sAssetBuy =
      2.8*(governanceFailure-0.5) +
      1.6*(ip-0.5) +
      1.0*(repro-0.5) +
      0.5*(transfer-0.5) -
      0.8*(runway-0.5);

  const sRestart =
      2.8*((1-ip)-0.5) +
      2.6*((1-repro)-0.5) +
      2.2*((1-transfer)-0.5) +
      1.4*((1-morale)-0.5) +
      1.2*(governanceFailure-0.5) -
      0.8*(concept-0.5);

  const sFreeWeb =
      2.2*(concept-0.5) -
      2.4*(gpu-0.5) -
      2.1*(buildfalse-0.5) -
      1.3*((1-runway)-0.5) -
      0.8*(integr-0.5);

  return {
    sEdu, sDiag, sBuyout, sAssetBuy, sRestart, sFreeWeb,
    derived: { governanceFailure, evidenceStrength, diagnosticReadiness, adoptionFriction, wedgePower, coreAssets }
  };
}

function scoreToProb(score, noiseStd){
  const noisy = score + noiseStd * randn();
  return clamp01(sigmoid(noisy));
}

/** ---------- Monte Carlo runner (fast/refine) ---------- */
function buildParamSnapshot(){
  return {
    runway:getParam("runway"),
    gov:getParam("gov"),
    morale:getParam("morale"),
    transfer:getParam("transfer"),
    repro:getParam("repro"),
    ip:getParam("ip"),
    trial:getParam("trial"),
    acc:getParam("acc"),
    mhra:getParam("mhra"),
    concept:getParam("concept"),
    pressure:getParam("pressure"),
    integr:getParam("integr"),
    timesave:getParam("timesave"),
    minint:getParam("minint"),
    gpu:getParam("gpu"),
    buildfalse:getParam("buildfalse"),
    runs:getParam("runs"),
    noise:getParam("noise"),
    bins:getParam("bins")
  };
}

function runSim(mode){
  // mode: "fast" uses fewer runs for responsiveness; "refine" uses slider-selected runs
  const p = buildParamSnapshot();
  const fullRuns = Math.max(200, Math.floor(p.runs));
  const fastRuns = Math.min(fullRuns, 1500); // keep responsive
  const runs = (mode==="fast") ? fastRuns : fullRuns;

  const noiseStd = 0.15 + 0.65 * to01(p.noise);
  const scores = computeDeterministicScores(p);

  const dist = {};
  OUTCOMES.forEach(o => dist[o.key] = new Array(runs));

  for(let i=0;i<runs;i++){
    dist.eduPilot[i] = scoreToProb(scores.sEdu, noiseStd);
    dist.diagPath[i] = scoreToProb(scores.sDiag, noiseStd);
    const buyoutScore = scores.sBuyout + 0.8*(dist.eduPilot[i]-0.5) - 0.35*(dist.diagPath[i]-0.5);
    dist.buyout[i] = scoreToProb(buyoutScore, noiseStd);
    dist.assetBuy[i] = scoreToProb(scores.sAssetBuy, noiseStd);
    dist.restart[i]  = scoreToProb(scores.sRestart, noiseStd);
    dist.freeWeb[i]  = scoreToProb(scores.sFreeWeb, noiseStd);
  }

  const means = {};
  OUTCOMES.forEach(o=>{
    const arr = dist[o.key];
    let s=0; for(const x of arr) s+=x;
    means[o.key] = s/arr.length;
  });

  const pathScores = [
    {name:"Education/QA wedge first", key:"eduPilot", v:means.eduPilot},
    {name:"Diagnostic pathway soon", key:"diagPath", v:means.diagPath},
    {name:"Buy company (buyout)", key:"buyout", v:means.buyout},
    {name:"Buy assets into NewCo", key:"assetBuy", v:means.assetBuy},
    {name:"Restart clean", key:"restart", v:means.restart},
    {name:"Free web traction", key:"freeWeb", v:means.freeWeb}
  ].sort((a,b)=>b.v-a.v);

  const primaryBlocker = computePrimaryBlocker(p);

  // Render
  renderBar(means);
  renderHistogram(dist[distSelect.value], means[distSelect.value], Math.floor(p.bins));
  renderExplanation(p, scores, means, primaryBlocker, pathScores[0]);

  document.getElementById("bestPath").textContent = `${pathScores[0].name} (${fmtPct(pathScores[0].v)})`;
  document.getElementById("bestPathNote").textContent =
    (mode==="fast")
      ? "Fast update while dragging; values will refine after you stop."
      : "Refined using full run-count. Explore slider moves to improve this.";

  document.getElementById("blocker").textContent = primaryBlocker.name;
  document.getElementById("blockerNote").textContent = primaryBlocker.why;

  window.__last = {p, scores, means, dist, primaryBlocker, pathScores, mode, runsUsed:runs};
}

function computePrimaryBlocker(p){
  const blockers = [];
  const runway = to01(p.runway), gov = to01(p.gov), mhra=to01(p.mhra), trial=to01(p.trial), acc=to01(p.acc);
  const pressure=to01(p.pressure), integr=to01(p.integr), transfer=to01(p.transfer), repro=to01(p.repro), ip=to01(p.ip);

  if(runway < 0.25) blockers.push({name:"Low runway", why:"Without time/cash buffer, you can’t embed innovation, run pilots, or generate evidence."});
  if(gov < 0.35) blockers.push({name:"Governance failure risk", why:"If incentives remain misaligned, new resources are likely to be wasted again."});
  if(transfer < 0.35) blockers.push({name:"Innovation not transferable", why:"Undocumented / not embedded work can’t reliably become a product or be sold."});
  if(repro < 0.40) blockers.push({name:"Non-reproducible build", why:"If you can’t rebuild and run deterministically, validation and iteration stall."});
  if(ip < 0.45) blockers.push({name:"Unclear IP/data rights", why:"Weak chain-of-title or uncertain data rights make deals and deployments high-risk."});
  if(mhra < 0.35 && (trial < 0.50 || acc < 0.50)) blockers.push({name:"Evidence & readiness gap", why:"Partial trials + questionable accuracy block diagnostic positioning and buyer confidence."});
  if(pressure > 0.70 && integr > 0.60) blockers.push({name:"User pressure + integration friction", why:"Overloaded users won’t tolerate workflow disruption unless you save time immediately."});

  return blockers.length ? blockers[0] : {name:"No single dominant blocker", why:"Several medium constraints—pick the fastest-to-improve leverage point."};
}

/** ---------- Charts with readable legends ---------- */
function drawAxes(ctx, w, h, pad){
  ctx.strokeStyle = "rgba(36,48,88,.9)";
  ctx.lineWidth = 1.25;
  ctx.beginPath();
  ctx.moveTo(pad, pad);
  ctx.lineTo(pad, h-pad);
  ctx.lineTo(w-pad, h-pad);
  ctx.stroke();
}

function renderBar(means){
  const canvas = document.getElementById("barChart");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const pad = 54; // bigger for labels
  drawAxes(ctx,w,h,pad);

  // Big readable font for legends
  ctx.font = "16px " + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = "rgba(232,236,255,.95)";
  ctx.fillText("Outcome probabilities (mean)", pad, 28);

  // Y grid + labels
  ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = "rgba(170,180,230,.95)";
  for(let t=0;t<=4;t++){
    const y = pad + (h-2*pad) * (1 - t/4);
    ctx.strokeStyle = "rgba(36,48,88,.6)";
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke();
    ctx.fillText((t/4).toFixed(2), 10, y+5);
  }

  const keys = OUTCOMES.map(o=>o.key);
  const labels = OUTCOMES.map(o=>o.label);
  const values = keys.map(k=>means[k] ?? 0);

  const barW = (w - pad*2) / values.length;

  for(let i=0;i<values.length;i++){
    const v = values[i];
    const x = pad + i*barW + 10;
    const bw = barW - 20;
    const bh = (h-2*pad) * v;
    const y = h - pad - bh;

    const grad = ctx.createLinearGradient(0,y,0,y+bh);
    grad.addColorStop(0,"rgba(122,162,255,.88)");
    grad.addColorStop(1,"rgba(97,230,198,.62)");
    ctx.fillStyle = grad;
    ctx.fillRect(x,y,bw,bh);

    // Value label
    ctx.fillStyle = "rgba(232,236,255,.98)";
    ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText(fmtPct(v), x, y-8);

    // Rotated label for readability
    ctx.save();
    ctx.translate(x + bw/2, h - pad + 18);
    ctx.rotate(-Math.PI/6);
    ctx.fillStyle = "rgba(170,180,230,.98)";
    ctx.font = "13px " + getComputedStyle(document.body).fontFamily;
    const lab = labels[i];
    ctx.textAlign = "center";
    ctx.fillText(lab, 0, 0);
    ctx.restore();
  }

  // Axis label
  ctx.fillStyle = "rgba(170,180,230,.95)";
  ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
  ctx.fillText("Probability", pad, h - 10);
}

function renderHistogram(arr, mean, bins){
  const canvas = document.getElementById("histChart");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const pad = 54;
  drawAxes(ctx,w,h,pad);

  const nBins = Math.max(6, Math.min(40, Math.floor(bins)));
  const hist = new Array(nBins).fill(0);
  for(const x of arr){
    const idx = Math.min(nBins-1, Math.max(0, Math.floor(x * nBins)));
    hist[idx] += 1;
  }
  const maxCount = Math.max(...hist, 1);
  const barW = (w - pad*2) / nBins;

  // Title
  ctx.font = "16px " + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = "rgba(232,236,255,.95)";
  ctx.fillText("Distribution of simulated probabilities", pad, 28);

  // Bars
  for(let i=0;i<nBins;i++){
    const c = hist[i];
    const x = pad + i*barW + 1;
    const bw = barW - 2;
    const bh = (h-2*pad) * (c / maxCount);
    const y = h - pad - bh;

    ctx.fillStyle = "rgba(122,162,255,.55)";
    ctx.fillRect(x,y,bw,bh);
  }

  // Mean line
  const meanX = pad + mean * (w-2*pad);
  ctx.strokeStyle = "rgba(255,204,102,.98)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(meanX, pad);
  ctx.lineTo(meanX, h-pad);
  ctx.stroke();

  ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = "rgba(255,204,102,.98)";
  ctx.fillText("mean " + fmtPct(mean), Math.min(meanX+10, w-pad-120), pad+18);

  // X ticks
  ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = "rgba(170,180,230,.95)";
  for(let t=0;t<=5;t++){
    const x = pad + (w-2*pad)*(t/5);
    ctx.strokeStyle = "rgba(36,48,88,.55)";
    ctx.beginPath(); ctx.moveTo(x,pad); ctx.lineTo(x,h-pad); ctx.stroke();
    ctx.fillText((t/5).toFixed(1), x-10, h-pad+22);
  }
}

/** ---------- Explanations (“why”) ---------- */
function makeOutcomeWhy(name, prob, factors){
  const contrib = factors.map(([label,val,sign])=>{
    const mag = (val - 0.5) * sign;
    return {label, mag, val};
  }).sort((a,b)=>Math.abs(b.mag)-Math.abs(a.mag));

  const top = contrib.slice(0,4);
  const bullets = top.map(x=>{
    const direction = x.mag >= 0 ? "pushes up" : "pushes down";
    const arrow = x.mag >= 0 ? "↑" : "↓";
    return `• ${arrow} <b>${escapeHtml(x.label)}</b> (${fmt01(x.val)}) ${direction}`;
  }).join("<br>");

  const tag = prob > 0.66 ? `<span class="good">high</span>` : (prob < 0.33 ? `<span class="bad">low</span>` : `<span class="warn">mixed</span>`);
  return `<b>${escapeHtml(name)}:</b> ${fmtPct(prob)} (${tag})<br>${bullets}`;
}

function renderExplanation(p, scores, means, primaryBlocker, best){
  const { derived } = scores;
  const lines = [];
  lines.push(`<b>Best near-term path:</b> ${escapeHtml(best.name)} (${fmtPct(best.v)})`);
  lines.push(`<b>Primary blocker:</b> ${escapeHtml(primaryBlocker.name)} — ${escapeHtml(primaryBlocker.why)}`);
  lines.push(`<hr style="border:none;border-top:1px solid rgba(36,48,88,.75);margin:10px 0">`);

  lines.push(`<b>Derived constraints:</b>`);
  lines.push(`• Evidence strength (trial+accuracy): <span class="mono">${fmt01(derived.evidenceStrength)}</span>`);
  lines.push(`• Diagnostic readiness (MHRA+evidence+build): <span class="mono">${fmt01(derived.diagnosticReadiness)}</span>`);
  lines.push(`• Adoption friction (pressure+integration): <span class="mono">${fmt01(derived.adoptionFriction)}</span>`);
  lines.push(`• Wedge power (time-save+min integ): <span class="mono">${fmt01(derived.wedgePower)}</span>`);
  lines.push(`• Core assets (IP+repro+transfer): <span class="mono">${fmt01(derived.coreAssets)}</span>`);
  lines.push(`<hr style="border:none;border-top:1px solid rgba(36,48,88,.75);margin:10px 0">`);

  const reasons = [];
  reasons.push(makeOutcomeWhy("Education/QA pilot", means.eduPilot, [
    ["Concept strength", to01(p.concept), +1],
    ["Time-saving wedge", to01(p.timesave), +1],
    ["Minimal integration packaging", to01(p.minint), +1],
    ["User pressure", to01(p.pressure), -1],
    ["Integration friction", to01(p.integr), -1],
    ["Governance quality", to01(p.gov), +1],
    ["Morale", to01(p.morale), +1],
    ["Runway", to01(p.runway), +1]
  ]));

  reasons.push(makeOutcomeWhy("Diagnostic path soon", means.diagPath, [
    ["MHRA readiness", to01(p.mhra), +1],
    ["Trial completion", to01(p.trial), +1],
    ["Accuracy confidence", to01(p.acc), +1],
    ["Build reproducibility", to01(p.repro), +1],
    ["Runway", to01(p.runway), +1],
    ["User pressure", to01(p.pressure), -1],
    ["Integration friction", to01(p.integr), -1],
    ["Governance quality", to01(p.gov), +1]
  ]));

  reasons.push(makeOutcomeWhy("Buyout worthwhile", means.buyout, [
    ["Clean IP", to01(p.ip), +1],
    ["Reproducible build", to01(p.repro), +1],
    ["Innovation transferability", to01(p.transfer), +1],
    ["Education pilot success", means.eduPilot, +1],
    ["Governance quality", to01(p.gov), +1],
    ["GPU cost pressure", to01(p.gpu), -1],
    ["Runway", to01(p.runway), +1]
  ]));

  reasons.push(makeOutcomeWhy("Asset purchase into NewCo", means.assetBuy, [
    ["Governance failure risk", 1-to01(p.gov), +1],
    ["Clean IP", to01(p.ip), +1],
    ["Reproducible build", to01(p.repro), +1],
    ["Transferability", to01(p.transfer), +1],
    ["Runway (reduces need)", to01(p.runway), -1]
  ]));

  reasons.push(makeOutcomeWhy("Restart better", means.restart, [
    ["Unclear IP", 1-to01(p.ip), +1],
    ["Non-repro build", 1-to01(p.repro), +1],
    ["Non-transferable innovation", 1-to01(p.transfer), +1],
    ["Low morale", 1-to01(p.morale), +1],
    ["Governance failure risk", 1-to01(p.gov), +1],
    ["Concept strength (reduces restart need)", to01(p.concept), -1]
  ]));

  reasons.push(makeOutcomeWhy("Free web traction", means.freeWeb, [
    ["Concept strength", to01(p.concept), +1],
    ["GPU cost pressure", to01(p.gpu), -1],
    ["Build-it-false", to01(p.buildfalse), -1],
    ["Runway", to01(p.runway), +1],
    ["Integration friction", to01(p.integr), -1]
  ]));

  lines.push(`<b>Outcome drivers (top factors):</b><br><br>${reasons.join("<br><br>")}`);
  lines.push(`<div style="margin-top:10px;color:rgba(170,180,230,.95)">
    <b>Reading tip:</b> When “pressure” and “integration friction” are high, the model strongly prefers strategies that
    <b>save time immediately</b> and require <b>minimal integration</b> (education/QA wedge).
  </div>`);

  document.getElementById("explainBox").innerHTML = lines.join("<br>");
}

/** ---------- Real-time update scheduling (debounced refine) ---------- */
let fastTimer = null;
let refineTimer = null;
let isDragging = false;

function scheduleRealtimeUpdate(){
  // Fast mode: throttle to at most ~12 fps
  if(fastTimer) return;
  setStatus("fast");
  fastTimer = setTimeout(()=>{
    fastTimer = null;
    runSim("fast");
  }, 80);

  // Refine after idle
  if(refineTimer) clearTimeout(refineTimer);
  refineTimer = setTimeout(()=>{
    setStatus("refine");
    // Use a tiny delay so the status is visible
    setTimeout(()=>{
      runSim("refine");
      setStatus("ready");
    }, 50);
  }, 350); // idle threshold
}

function attachRealtimeHandlers(){
  sliderIds.forEach(id=>{
    const el = document.getElementById("p_"+id);
    if(!el) return;

    // On input, update readout and schedule sim
    el.addEventListener("input", ()=>{
      updateReadouts();
      // Histogram bins should apply immediately too
      scheduleRealtimeUpdate();
    });

    // Track dragging state for better UX (optional)
    el.addEventListener("pointerdown", ()=>{ isDragging = true; });
    el.addEventListener("pointerup", ()=>{ isDragging = false; });
    el.addEventListener("pointercancel", ()=>{ isDragging = false; });
  });

  distSelect.addEventListener("change", ()=>{
    if(!window.__last) return;
    const bins = getParam("bins");
    renderHistogram(window.__last.dist[distSelect.value], window.__last.means[distSelect.value], bins);
  });
}
attachRealtimeHandlers();

/** ---------- Suggestions (same as before, but compatible with realtime sim state) ---------- */
function snapshotParams(){
  return buildParamSnapshot();
}

function applyChanges(base, changes){
  const out = {...base};
  Object.keys(changes).forEach(k=> out[k] = changes[k]);
  return out;
}
function mergeChanges(a,b){ return {...a, ...b}; }

function evaluateQuick(pMod){
  const scores = computeDeterministicScores(pMod);
  const noiseStd = 0.15 + 0.65 * to01(pMod.noise);
  const runs = 1500;
  const dist = {eduPilot:[], diagPath:[], buyout:[], assetBuy:[], restart:[], freeWeb:[]};
  for(let i=0;i<runs;i++){
    dist.eduPilot.push(scoreToProb(scores.sEdu, noiseStd));
    dist.diagPath.push(scoreToProb(scores.sDiag, noiseStd));
    const buyoutScore = scores.sBuyout + 0.8*(dist.eduPilot[i]-0.5) - 0.35*(dist.diagPath[i]-0.5);
    dist.buyout.push(scoreToProb(buyoutScore, noiseStd));
    dist.assetBuy.push(scoreToProb(scores.sAssetBuy, noiseStd));
    dist.restart.push(scoreToProb(scores.sRestart, noiseStd));
    dist.freeWeb.push(scoreToProb(scores.sFreeWeb, noiseStd));
  }
  const mean = a => a.reduce((s,x)=>s+x,0)/a.length;
  const means = {};
  Object.keys(dist).forEach(k=> means[k] = mean(dist[k]));

  const objective =
    0.55*means.eduPilot +
    0.20*means.buyout +
    0.15*means.diagPath +
    0.10*means.assetBuy -
    0.35*means.restart;

  return {means, objective};
}

function diffParams(base, mod){
  const keys = Object.keys(base).filter(k=>document.getElementById("p_"+k));
  const changes = keys
    .map(k=>({k, d: mod[k]-base[k]}))
    .filter(x=>Math.abs(x.d) >= 5)
    .sort((a,b)=>Math.abs(b.d)-Math.abs(a.d))
    .slice(0,8);

  if(!changes.length) return "(no major slider changes)";
  return changes.map(x=>{
    const sign = x.d>0 ? "+" : "";
    return `• <span class="mono">${x.k}</span>: ${base[x.k]} → ${mod[x.k]} (<span class="mono">${sign}${x.d}</span>)`;
  }).join("<br>");
}

function renderPlans(plans, base){
  const el = document.getElementById("plans");
  el.innerHTML = "";
  plans.forEach((p, idx)=>{
    const diff = diffParams(base, p.params);
    const box = document.createElement("div");
    box.className = "plan";

    box.innerHTML = `
      <h3>#${idx+1} ${escapeHtml(p.name)}</h3>
      <div class="note">
        Objective score: <span class="mono">${p.objective.toFixed(3)}</span><br>
        <b>Projected:</b> Education pilot ${fmtPct(p.means.eduPilot)} · Buyout ${fmtPct(p.means.buyout)} ·
        Diagnostic soon ${fmtPct(p.means.diagPath)} · Restart ${fmtPct(p.means.restart)}
      </div>
      <div class="divider"></div>
      <div class="note"><b>Parameter moves:</b><br>${diff}</div>
      <ul>${p.notes.map(n=>`<li>${escapeHtml(n)}</li>`).join("")}</ul>
      <div class="btns" style="margin-top:10px">
        <button class="secondary" data-apply="${idx}">Apply this plan</button>
      </div>
    `;
    el.appendChild(box);
  });

  el.querySelectorAll("button[data-apply]").forEach((btn, i)=>{
    btn.addEventListener("click", ()=>{
      const chosen = plans[i];
      Object.keys(chosen.params).forEach(k=>{
        const el = document.getElementById("p_"+k);
        if(el) setParam(k, chosen.params[k]);
      });
      updateReadouts();
      setStatus("refine");
      setTimeout(()=>{
        runSim("refine");
        setStatus("ready");
      }, 30);
      window.scrollTo({top:0, behavior:"smooth"});
    });
  });
}

function suggestBestOptions(){
  const base = snapshotParams();
  const planDefs = [
    {
      name:"Education/QA wedge hard-pivot",
      changes: {
        timesave: Math.min(95, base.timesave + 30),
        minint: Math.min(95, base.minint + 25),
        integr: Math.max(20, base.integr - 25),
      },
      notes:[
        "Package as training + QA tooling (not diagnostic).",
        "Pilots must reduce onboarding/QA time in week 1.",
        "Minimise disruption: CSV/batch + web dashboard first."
      ]
    },
    {
      name:"Embed & document innovation (reduce bus-factor)",
      changes: {
        transfer: Math.min(95, base.transfer + 45),
        repro: Math.min(95, base.repro + 25),
        morale: Math.min(85, base.morale + 15),
      },
      notes:[
        "Turn the ophthalmologist’s work into a reproducible pipeline + minimal API boundary.",
        "Document failure modes + ‘what flips the decision’ for trust.",
        "Increases asset value for any path."
      ]
    },
    {
      name:"Governance reset + asset purchase into NewCo",
      changes: {
        gov: Math.min(90, base.gov + 45),
        ip: Math.min(95, base.ip + 20),
        morale: Math.min(80, base.morale + 10),
      },
      notes:[
        "Treat the deal as asset acquisition: clean cap table + clear decision rights.",
        "Milestone-based compensation and transparent burn reporting.",
        "Prevents repeating the original failure mode."
      ]
    },
    {
      name:"Reduce GPU cost risk + wedge pivot",
      changes: {
        gpu: Math.max(20, base.gpu - 35),
        timesave: Math.min(90, base.timesave + 20),
        minint: Math.min(90, base.minint + 15),
      },
      notes:[
        "Avoid always-on GPU; use burst/batch/CPU where possible.",
        "Lower operating risk makes pilots less dangerous.",
        "Pairs well with education wedge."
      ]
    },
    {
      name:"Diagnostic push (only if evidence improves)",
      changes: {
        mhra: Math.min(85, base.mhra + 40),
        trial: Math.min(90, base.trial + 45),
        acc: Math.min(90, base.acc + 35),
        runway: Math.min(80, base.runway + 25),
        integr: Math.max(30, base.integr - 15),
      },
      notes:[
        "Requires serious evidence generation and quality system work.",
        "Not a near-term revenue play without capital + pathway owner.",
        "Use only if you can actually fund trials/validation."
      ]
    },
  ];

  const expanded = [];
  planDefs.forEach(d => expanded.push({name:d.name, params:applyChanges(base, d.changes), notes:d.notes}));
  expanded.push({
    name:"(Combo) Governance reset + embed innovation + education wedge",
    params: applyChanges(base, mergeChanges(planDefs[0].changes, mergeChanges(planDefs[1].changes, planDefs[2].changes))),
    notes:[
      "Most realistic ‘restart energy’ without losing assets.",
      "Makes pilots purchasable while increasing asset value.",
      "De-risks single-threaded innovation and governance recurrence."
    ]
  });
  expanded.push({
    name:"(Combo) Education wedge + GPU risk reduction",
    params: applyChanges(base, mergeChanges(planDefs[0].changes, planDefs[3].changes)),
    notes:[
      "Fastest route to low-cost proofs.",
      "Best when cash-constrained and hosting surprises must be avoided."
    ]
  });

  const candidates = expanded.map(c=>{
    const ev = evaluateQuick(c.params);
    return {...c, ...ev};
  }).sort((a,b)=>b.objective-a.objective);

  renderPlans(candidates.slice(0,3), base);
}

/** ---------- Prompt generator ---------- */
function generatePrompt(){
  const last = window.__last || { p: snapshotParams(), means:null, primaryBlocker:null, pathScores:null };
  const p = last.p;

  const angle = document.getElementById("promptTitle").value.trim() || "A realistic path forward under severe constraints";
  const userText = document.getElementById("caseInput").value.trim();

  const means = last.means || {};
  const best = (last.pathScores && last.pathScores[0]) ? last.pathScores[0] : null;

  const summary = [
    `Runway=${p.runway}/100`,
    `Governance=${p.gov}/100`,
    `Morale=${p.morale}/100`,
    `Transferability=${p.transfer}/100`,
    `ReproducibleBuild=${p.repro}/100`,
    `IPClarity=${p.ip}/100`,
    `TrialCompletion=${p.trial}/100`,
    `AccuracyConfidence=${p.acc}/100`,
    `MHRAReadiness=${p.mhra}/100`,
    `ConceptStrength=${p.concept}/100`,
    `UserPressure=${p.pressure}/100`,
    `IntegrationFriction=${p.integr}/100`,
    `TimeSavingWedge=${p.timesave}/100`,
    `MinimalIntegration=${p.minint}/100`,
    `GPUCost=${p.gpu}/100`,
    `BuildItFalse=${p.buildfalse}/100`,
    `Noise=${p.noise}/100`
  ].join(", ");

  const outcomeLine = last.means ? (
    `Modelled outcome means: ` +
    `EducationPilot=${fmtPct(means.eduPilot||0)}, ` +
    `DiagnosticSoon=${fmtPct(means.diagPath||0)}, ` +
    `Buyout=${fmtPct(means.buyout||0)}, ` +
    `AssetPurchase=${fmtPct(means.assetBuy||0)}, ` +
    `Restart=${fmtPct(means.restart||0)}, ` +
    `FreeWeb=${fmtPct(means.freeWeb||0)}.`
  ) : `No simulation has been run yet; infer likely outcomes qualitatively.`;

  const blockerLine = last.primaryBlocker
    ? `Primary blocker identified: ${last.primaryBlocker.name} — ${last.primaryBlocker.why}`
    : `Primary blocker: infer from parameters (runway, governance, evidence gap, user pressure, etc.).`;

  const bestLine = best ? `Best near-term path suggested: ${best.name} (~${fmtPct(best.v)}).` : "";

  const prompt =
`You are an expert in clinical diagnostics innovation, AI product strategy, and health-tech adoption.

Write an IMAGINARY but realistic case study titled:
"${angle}"

Context:
- A startup built an AI diabetic retinopathy tool. The core concept (human–machine interface / teaching via model representations) is strong, but the technology base is older.
- Funding was wasted on leadership salaries; technical progress stalled; morale is damaged.
- Clinical trials are only partially completed; MHRA readiness is low; current accuracy is questionable (concept works, evidence incomplete).
- User testing is difficult because graders/users are under intense workflow pressure and avoid new complexity; integration friction is a key barrier.
- The near-term opportunity may be an EDUCATIONAL / QA wedge rather than a diagnostic claim.

Parameters (0–100):
${summary}

${outcomeLine}
${blockerLine}
${bestLine}

User-supplied specifics:
${userText || "(none provided)"}

Requirements:
1) Describe the situation, stakeholders, and constraints in concrete terms.
2) Pick a best-fit strategy (education/QA wedge, asset purchase into NewCo, embed/document innovation, evidence roadmap) and justify it.
3) Give a 90-day plan with: smallest purchasable pilot, success metrics (onboarding time, grader consistency, QA rework), and how to reduce user testing burden.
4) Explain WHY this strategy works despite questionable accuracy and partial trials (intended-use boundaries, workflow design, risk controls).
5) Include a “what went wrong before” section and a governance reset to prevent recurrence.
6) End with measurable outcomes and a decision gate: continue / pivot / sell / restart.

Tone: pragmatic, detailed, non-hype, focused on adoption and evidence.`;

  document.getElementById("promptOut").value = prompt;
}

/** ---------- Buttons ---------- */
document.getElementById("btnSuggest").addEventListener("click", suggestBestOptions);

document.getElementById("btnReset").addEventListener("click", ()=>{
  // Baseline "current story"
  setParam("runway", 10);
  setParam("gov", 25);
  setParam("morale", 35);
  setParam("transfer", 20);
  setParam("repro", 30);
  setParam("ip", 40);
  setParam("trial", 30);
  setParam("acc", 35);
  setParam("mhra", 15);
  setParam("concept", 75);
  setParam("pressure", 85);
  setParam("integr", 70);
  setParam("timesave", 45);
  setParam("minint", 55);
  setParam("gpu", 70);
  setParam("buildfalse", 80);
  setParam("runs", 5000);
  setParam("noise", 30);
  setParam("bins", 20);

  updateReadouts();
  document.getElementById("plans").innerHTML = "";
  document.getElementById("promptOut").value = "";
  document.getElementById("promptTitle").value = "";
  document.getElementById("caseInput").value = "";
  setStatus("refine");
  setTimeout(()=>{ runSim("refine"); setStatus("ready"); }, 30);
});

document.getElementById("btnPrompt").addEventListener("click", generatePrompt);

document.getElementById("btnCopy").addEventListener("click", async ()=>{
  const txt = document.getElementById("promptOut").value;
  if(!txt) return;
  try{
    await navigator.clipboard.writeText(txt);
    alert("Copied prompt to clipboard.");
  }catch(e){
    alert("Copy failed — your browser may block clipboard access. You can select and copy manually.");
  }
});

// Bins readout
document.getElementById("v_bins").textContent = getParam("bins").toString();

/** ---------- Realtime init ---------- */
distSelect.addEventListener("change", scheduleRealtimeUpdate);

// Initial render
setStatus("refine");
setTimeout(()=>{
  runSim("refine");
  setStatus("ready");
}, 50);

// Also keep bins readout live
document.getElementById("p_bins").addEventListener("input", ()=>{
  document.getElementById("v_bins").textContent = getParam("bins").toString();
});
</script>
</body>
</html>
