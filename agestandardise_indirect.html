
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Direct vs Indirect Age Standardisation Tutor</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
    }

    header {
      background: #1e293b;
      color: #f9fafb;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    main {
      display: grid;
      grid-template-columns: minmax(260px, 1.1fr) minmax(520px, 1.6fr);
      gap: 1rem;
      padding: 1rem 1.5rem 1.5rem;
    }

    @media (max-width: 1000px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 1px 3px rgba(15,23,42,0.12);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card h2 {
      margin: 0;
      font-size: 1.15rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .step-title {
      font-weight: 600;
      font-size: 1.05rem;
    }

    .step-description {
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .formula-box,
    .question-box,
    .note-box {
      border-radius: 0.5rem;
      border: 1px dashed #cbd5f5;
      background: #f8fafc;
      padding: 0.6rem 0.75rem;
      font-size: 0.85rem;
    }

    .formula-box h3,
    .question-box h3,
    .note-box h3 {
      margin: 0 0 0.3rem;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .formula-list {
      margin: 0.25rem 0 0;
      padding-left: 1.1rem;
    }

    .formula-list li {
      margin-bottom: 0.15rem;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
    }

    .question-text {
      margin-bottom: 0.5rem;
    }

    textarea#reflection {
      width: 100%;
      min-height: 70px;
      border-radius: 0.4rem;
      border: 1px solid #cbd5e1;
      padding: 0.4rem 0.5rem;
      font-size: 0.85rem;
      resize: vertical;
      font-family: inherit;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.35rem 0.95rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-weight: 500;
    }

    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
    }

    .btn-primary:disabled {
      background: #bfdbfe;
      cursor: default;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #e5e7eb;
      color: #4b5563;
    }

    .btn span.icon {
      font-size: 0.95em;
    }

    .step-indicator {
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* Spreadsheet styling */
    .sheet-wrapper {
      overflow-x: auto;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    table.sheet {
      border-collapse: collapse;
      min-width: 900px;
      width: 100%;
      font-size: 0.8rem;
    }

    table.sheet th,
    table.sheet td {
      border: 1px solid #e5e7eb;
      padding: 0.35rem 0.4rem;
      text-align: right;
      min-width: 70px;
      position: relative;
    }

    table.sheet th[scope="col"] {
      background: #f3f4f6;
      font-weight: 600;
      text-align: center;
    }

    table.sheet th[scope="row"] {
      background: #f3f4f6;
      font-weight: 600;
      text-align: left;
      width: 150px;
      padding-left: 0.5rem;
    }

    .sheet-caption {
      font-size: 0.8rem;
      padding: 0.5rem 0.6rem;
      color: #4b5563;
    }

    .cell-label {
      position: absolute;
      top: 2px;
      left: 4px;
      font-size: 0.55rem;
      color: #9ca3af;
      pointer-events: none;
    }

    .cell-content {
      display: block;
      padding-left: 0.35rem;
    }

    .highlight {
      background: #fef3c7 !important;
      box-shadow: inset 0 0 0 1px #f97316;
      z-index: 1;
    }

    .readonly {
      background-color: #f9fafb;
    }

    .numeric-editable {
      background-color: #ffffff;
    }

    .numeric-editable .cell-content[contenteditable="true"] {
      cursor: text;
      min-height: 1.1em;
    }

    .numeric-editable .cell-content[contenteditable="true"]:focus {
      outline: none;
      background-color: #eff6ff;
    }

    .legend {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.35rem;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      border: 1px solid #cbd5e1;
    }

    .legend-swatch.data {
      background: #ffffff;
    }

    .legend-swatch.calc {
      background: #e5e7eb;
    }

    .legend-swatch.hl {
      background: #fed7aa;
      border-color: #f97316;
    }

    .summary-box {
      font-size: 0.8rem;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 0.5rem 0.6rem;
      margin-top: 0.4rem;
    }

    .summary-box strong {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body>
<header>
  <h1>Direct vs Indirect Age Standardisation Tutor</h1>
  <p>Follow the steps to calculate directly and indirectly age-standardised rates from simulated data.</p>
</header>

<main>
  <!-- Left: Step-by-step tutor -->
  <section class="card" aria-label="Step by step instructions">
    <div>
      <div class="badge">Guided walkthrough</div>
      <div class="step-title" id="step-title"></div>
    </div>

    <div class="step-description" id="step-description"></div>

    <div class="formula-box" id="formula-box">
      <h3>Spreadsheet formulas to try</h3>
      <ul class="formula-list" id="formula-list"></ul>
    </div>

    <div class="question-box">
      <h3>Think about this</h3>
      <div id="question-text" class="question-text"></div>
      <label for="reflection" style="font-size:0.8rem; display:block; margin-bottom:0.25rem;">
        Jot down your thoughts (optional):
      </label>
      <textarea id="reflection"></textarea>
    </div>

    <div class="note-box">
      <h3>Explanation</h3>
      <div id="explanation-text" style="font-size:0.85rem;"></div>
    </div>

    <div class="buttons">
      <button class="btn btn-secondary" id="prev-btn">
        <span class="icon">←</span> Previous
      </button>
      <div class="step-indicator" id="step-indicator"></div>
      <div style="display:flex; gap:0.4rem;">
        <button class="btn btn-ghost" id="recalc-btn" title="Recalculate using the current data">
          Recalculate
        </button>
        <button class="btn btn-primary" id="next-btn">
          Next <span class="icon">→</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Right: Spreadsheet-like grid -->
  <section class="card" aria-label="Spreadsheet view">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
      <h2>
        Spreadsheet
        <span style="font-size:0.8rem; font-weight:400; color:#6b7280;">(study vs reference region)</span>
      </h2>
    </div>
    <p style="font-size:0.85rem; margin:0;">
      Age-specific populations and cancer cases for a <strong>study region</strong> and a <strong>reference (standard) region</strong>,
      plus a chosen <strong>standard population</strong>. Edit the white cells (populations and cases) and press
      <strong>Recalculate</strong> to see how direct and indirect standardisation respond.
    </p>

    <div class="sheet-wrapper">
      <div class="sheet-caption">
        Direct and indirect standardisation example: comparing cancer incidence in a study region vs a reference region.
      </div>
      <table class="sheet" aria-label="Spreadsheet-like data table">
        <thead>
        <tr>
          <th></th>
          <th scope="col">A</th>
          <th scope="col">B</th>
          <th scope="col">C</th>
          <th scope="col">D</th>
          <th scope="col">E</th>
          <th scope="col">F</th>
          <th scope="col">G</th>
          <th scope="col">H</th>
          <th scope="col">I</th>
          <th scope="col">J</th>
          <th scope="col">K</th>
        </tr>
        </thead>
        <tbody>
        <!-- Row 1 (column headers) -->
        <tr>
          <th scope="row">1</th>
          <td data-cell="A1" class="readonly"><span class="cell-label">A1</span><span class="cell-content"></span></td>
          <td data-cell="B1" class="readonly"><span class="cell-label">B1</span><span class="cell-content"></span></td>
          <td data-cell="C1" class="readonly"><span class="cell-label">C1</span><span class="cell-content"></span></td>
          <td data-cell="D1" class="readonly"><span class="cell-label">D1</span><span class="cell-content"></span></td>
          <td data-cell="E1" class="readonly"><span class="cell-label">E1</span><span class="cell-content"></span></td>
          <td data-cell="F1" class="readonly"><span class="cell-label">F1</span><span class="cell-content"></span></td>
          <td data-cell="G1" class="readonly"><span class="cell-label">G1</span><span class="cell-content"></span></td>
          <td data-cell="H1" class="readonly"><span class="cell-label">H1</span><span class="cell-content"></span></td>
          <td data-cell="I1" class="readonly"><span class="cell-label">I1</span><span class="cell-content"></span></td>
          <td data-cell="J1" class="readonly"><span class="cell-label">J1</span><span class="cell-content"></span></td>
          <td data-cell="K1" class="readonly"><span class="cell-label">K1</span><span class="cell-content"></span></td>
        </tr>

        <!-- Rows 2–6: age bands -->
        <!-- Row 2 -->
        <tr>
          <th scope="row">2</th>
          <td data-cell="A2" class="readonly"><span class="cell-label">A2</span><span class="cell-content"></span></td>
          <td data-cell="B2" class="readonly"><span class="cell-label">B2</span><span class="cell-content"></span></td>
          <td data-cell="C2" class="numeric-editable">
            <span class="cell-label">C2</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="D2" class="numeric-editable">
            <span class="cell-label">D2</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="E2" class="numeric-editable">
            <span class="cell-label">E2</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="F2" class="numeric-editable">
            <span class="cell-label">F2</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="G2" class="readonly"><span class="cell-label">G2</span><span class="cell-content"></span></td>
          <td data-cell="H2" class="readonly"><span class="cell-label">H2</span><span class="cell-content"></span></td>
          <td data-cell="I2" class="readonly"><span class="cell-label">I2</span><span class="cell-content"></span></td>
          <td data-cell="J2" class="readonly"><span class="cell-label">J2</span><span class="cell-content"></span></td>
          <td data-cell="K2" class="readonly"><span class="cell-label">K2</span><span class="cell-content"></span></td>
        </tr>
        <!-- Row 3 -->
        <tr>
          <th scope="row">3</th>
          <td data-cell="A3" class="readonly"><span class="cell-label">A3</span><span class="cell-content"></span></td>
          <td data-cell="B3" class="readonly"><span class="cell-label">B3</span><span class="cell-content"></span></td>
          <td data-cell="C3" class="numeric-editable">
            <span class="cell-label">C3</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="D3" class="numeric-editable">
            <span class="cell-label">D3</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="E3" class="numeric-editable">
            <span class="cell-label">E3</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="F3" class="numeric-editable">
            <span class="cell-label">F3</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="G3" class="readonly"><span class="cell-label">G3</span><span class="cell-content"></span></td>
          <td data-cell="H3" class="readonly"><span class="cell-label">H3</span><span class="cell-content"></span></td>
          <td data-cell="I3" class="readonly"><span class="cell-label">I3</span><span class="cell-content"></span></td>
          <td data-cell="J3" class="readonly"><span class="cell-label">J3</span><span class="cell-content"></span></td>
          <td data-cell="K3" class="readonly"><span class="cell-label">K3</span><span class="cell-content"></span></td>
        </tr>
        <!-- Row 4 -->
        <tr>
          <th scope="row">4</th>
          <td data-cell="A4" class="readonly"><span class="cell-label">A4</span><span class="cell-content"></span></td>
          <td data-cell="B4" class="readonly"><span class="cell-label">B4</span><span class="cell-content"></span></td>
          <td data-cell="C4" class="numeric-editable">
            <span class="cell-label">C4</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="D4" class="numeric-editable">
            <span class="cell-label">D4</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="E4" class="numeric-editable">
            <span class="cell-label">E4</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="F4" class="numeric-editable">
            <span class="cell-label">F4</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="G4" class="readonly"><span class="cell-label">G4</span><span class="cell-content"></span></td>
          <td data-cell="H4" class="readonly"><span class="cell-label">H4</span><span class="cell-content"></span></td>
          <td data-cell="I4" class="readonly"><span class="cell-label">I4</span><span class="cell-content"></span></td>
          <td data-cell="J4" class="readonly"><span class="cell-label">J4</span><span class="cell-content"></span></td>
          <td data-cell="K4" class="readonly"><span class="cell-label">K4</span><span class="cell-content"></span></td>
        </tr>
        <!-- Row 5 -->
        <tr>
          <th scope="row">5</th>
          <td data-cell="A5" class="readonly"><span class="cell-label">A5</span><span class="cell-content"></span></td>
          <td data-cell="B5" class="readonly"><span class="cell-label">B5</span><span class="cell-content"></span></td>
          <td data-cell="C5" class="numeric-editable">
            <span class="cell-label">C5</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="D5" class="numeric-editable">
            <span class="cell-label">D5</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="E5" class="numeric-editable">
            <span class="cell-label">E5</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="F5" class="numeric-editable">
            <span class="cell-label">F5</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="G5" class="readonly"><span class="cell-label">G5</span><span class="cell-content"></span></td>
          <td data-cell="H5" class="readonly"><span class="cell-label">H5</span><span class="cell-content"></span></td>
          <td data-cell="I5" class="readonly"><span class="cell-label">I5</span><span class="cell-content"></span></td>
          <td data-cell="J5" class="readonly"><span class="cell-label">J5</span><span class="cell-content"></span></td>
          <td data-cell="K5" class="readonly"><span class="cell-label">K5</span><span class="cell-content"></span></td>
        </tr>
        <!-- Row 6 -->
        <tr>
          <th scope="row">6</th>
          <td data-cell="A6" class="readonly"><span class="cell-label">A6</span><span class="cell-content"></span></td>
          <td data-cell="B6" class="readonly"><span class="cell-label">B6</span><span class="cell-content"></span></td>
          <td data-cell="C6" class="numeric-editable">
            <span class="cell-label">C6</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="D6" class="numeric-editable">
            <span class="cell-label">D6</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="E6" class="numeric-editable">
            <span class="cell-label">E6</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="F6" class="numeric-editable">
            <span class="cell-label">F6</span><span class="cell-content" contenteditable="true"></span>
          </td>
          <td data-cell="G6" class="readonly"><span class="cell-label">G6</span><span class="cell-content"></span></td>
          <td data-cell="H6" class="readonly"><span class="cell-label">H6</span><span class="cell-content"></span></td>
          <td data-cell="I6" class="readonly"><span class="cell-label">I6</span><span class="cell-content"></span></td>
          <td data-cell="J6" class="readonly"><span class="cell-label">J6</span><span class="cell-content"></span></td>
          <td data-cell="K6" class="readonly"><span class="cell-label">K6</span><span class="cell-content"></span></td>
        </tr>

        <!-- Row 7: totals -->
        <tr>
          <th scope="row">7</th>
          <td data-cell="A7" class="readonly"><span class="cell-label">A7</span><span class="cell-content"></span></td>
          <td data-cell="B7" class="readonly"><span class="cell-label">B7</span><span class="cell-content"></span></td>
          <td data-cell="C7" class="readonly"><span class="cell-label">C7</span><span class="cell-content"></span></td>
          <td data-cell="D7" class="readonly"><span class="cell-label">D7</span><span class="cell-content"></span></td>
          <td data-cell="E7" class="readonly"><span class="cell-label">E7</span><span class="cell-content"></span></td>
          <td data-cell="F7" class="readonly"><span class="cell-label">F7</span><span class="cell-content"></span></td>
          <td data-cell="G7" class="readonly"><span class="cell-label">G7</span><span class="cell-content"></span></td>
          <td data-cell="H7" class="readonly"><span class="cell-label">H7</span><span class="cell-content"></span></td>
          <td data-cell="I7" class="readonly"><span class="cell-label">I7</span><span class="cell-content"></span></td>
          <td data-cell="J7" class="readonly"><span class="cell-label">J7</span><span class="cell-content"></span></td>
          <td data-cell="K7" class="readonly"><span class="cell-label">K7</span><span class="cell-content"></span></td>
        </tr>

        <!-- Row 8: crude rates -->
        <tr>
          <th scope="row">8</th>
          <td data-cell="A8" class="readonly"><span class="cell-label">A8</span><span class="cell-content"></span></td>
          <td data-cell="B8" class="readonly"><span class="cell-label">B8</span><span class="cell-content"></span></td>
          <td data-cell="C8" class="readonly"><span class="cell-label">C8</span><span class="cell-content"></span></td>
          <td data-cell="D8" class="readonly"><span class="cell-label">D8</span><span class="cell-content"></span></td>
          <td data-cell="E8" class="readonly"><span class="cell-label">E8</span><span class="cell-content"></span></td>
          <td data-cell="F8" class="readonly"><span class="cell-label">F8</span><span class="cell-content"></span></td>
          <td data-cell="G8" class="readonly"><span class="cell-label">G8</span><span class="cell-content"></span></td>
          <td data-cell="H8" class="readonly"><span class="cell-label">H8</span><span class="cell-content"></span></td>
          <td data-cell="I8" class="readonly"><span class="cell-label">I8</span><span class="cell-content"></span></td>
          <td data-cell="J8" class="readonly"><span class="cell-label">J8</span><span class="cell-content"></span></td>
          <td data-cell="K8" class="readonly"><span class="cell-label">K8</span><span class="cell-content"></span></td>
        </tr>

        <!-- Row 9: directly age-standardised rates -->
        <tr>
          <th scope="row">9</th>
          <td data-cell="A9" class="readonly"><span class="cell-label">A9</span><span class="cell-content"></span></td>
          <td data-cell="B9" class="readonly"><span class="cell-label">B9</span><span class="cell-content"></span></td>
          <td data-cell="C9" class="readonly"><span class="cell-label">C9</span><span class="cell-content"></span></td>
          <td data-cell="D9" class="readonly"><span class="cell-label">D9</span><span class="cell-content"></span></td>
          <td data-cell="E9" class="readonly"><span class="cell-label">E9</span><span class="cell-content"></span></td>
          <td data-cell="F9" class="readonly"><span class="cell-label">F9</span><span class="cell-content"></span></td>
          <td data-cell="G9" class="readonly"><span class="cell-label">G9</span><span class="cell-content"></span></td>
          <td data-cell="H9" class="readonly"><span class="cell-label">H9</span><span class="cell-content"></span></td>
          <td data-cell="I9" class="readonly"><span class="cell-label">I9</span><span class="cell-content"></span></td>
          <td data-cell="J9" class="readonly"><span class="cell-label">J9</span><span class="cell-content"></span></td>
          <td data-cell="K9" class="readonly"><span class="cell-label">K9</span><span class="cell-content"></span></td>
        </tr>

        <!-- Row 10: indirect standardisation / SMR -->
        <tr>
          <th scope="row">10</th>
          <td data-cell="A10" class="readonly"><span class="cell-label">A10</span><span class="cell-content"></span></td>
          <td data-cell="B10" class="readonly"><span class="cell-label">B10</span><span class="cell-content"></span></td>
          <td data-cell="C10" class="readonly"><span class="cell-label">C10</span><span class="cell-content"></span></td>
          <td data-cell="D10" class="readonly"><span class="cell-label">D10</span><span class="cell-content"></span></td>
          <td data-cell="E10" class="readonly"><span class="cell-label">E10</span><span class="cell-content"></span></td>
          <td data-cell="F10" class="readonly"><span class="cell-label">F10</span><span class="cell-content"></span></td>
          <td data-cell="G10" class="readonly"><span class="cell-label">G10</span><span class="cell-content"></span></td>
          <td data-cell="H10" class="readonly"><span class="cell-label">H10</span><span class="cell-content"></span></td>
          <td data-cell="I10" class="readonly"><span class="cell-label">I10</span><span class="cell-content"></span></td>
          <td data-cell="J10" class="readonly"><span class="cell-label">J10</span><span class="cell-content"></span></td>
          <td data-cell="K10" class="readonly"><span class="cell-label">K10</span><span class="cell-content"></span></td>
        </tr>
        </tbody>
      </table>
    </div>

    <div class="legend">
      <span><span class="legend-swatch data"></span> Editable data cells</span>
      <span><span class="legend-swatch calc"></span> Calculated cells</span>
      <span><span class="legend-swatch.hl"></span> Cells for this step</span>
    </div>

    <div class="summary-box" id="summary-box"></div>
  </section>
</main>

<script>
  (function () {
    const cells = {};

    // Simulated base data (you can change in the UI)
    const ageBandsBase = [
      {
        label: "0–24",
        stdPop: 25000,
        studyPop: 22000,
        studyCases: 8,
        refPop: 24000,
        refCases: 10
      },
      {
        label: "25–44",
        stdPop: 20000,
        studyPop: 20000,
        studyCases: 18,
        refPop: 21000,
        refCases: 22
      },
      {
        label: "45–64",
        stdPop: 15000,
        studyPop: 17000,
        studyCases: 34,
        refPop: 16000,
        refCases: 30
      },
      {
        label: "65–74",
        stdPop: 10000,
        studyPop: 9000,
        studyCases: 24,
        refPop: 11000,
        refCases: 32
      },
      {
        label: "75+",
        stdPop: 8000,
        studyPop: 6000,
        studyCases: 21,
        refPop: 9000,
        refCases: 36
      }
    ];

    function formatNumber(value, decimals) {
      if (value === null || value === undefined || isNaN(value)) return "";
      return value.toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function setCell(cellId, value, decimals) {
      const td = cells[cellId];
      if (!td) return;
      const content = td.querySelector(".cell-content");
      if (typeof value === "number" && decimals !== undefined) {
        content.textContent = formatNumber(value, decimals);
      } else {
        content.textContent = value;
      }
    }

    function getEditableNumber(cellId, fallback) {
      const td = cells[cellId];
      if (!td) return fallback;
      const content = td.querySelector(".cell-content");
      const raw = content.textContent.replace(/,/g, "").trim();
      if (raw === "") return fallback;
      const val = parseFloat(raw);
      if (isNaN(val) || val < 0) return fallback;
      return val;
    }

    function cacheCells() {
      document.querySelectorAll("[data-cell]").forEach(td => {
        const id = td.getAttribute("data-cell");
        cells[id] = td;
      });
    }

    function initialiseSheet() {
      // Column headers
      setCell("A1", "Age band");
      setCell("B1", "Standard pop");
      setCell("C1", "Study pop");
      setCell("D1", "Study cases");
      setCell("E1", "Ref pop");
      setCell("F1", "Ref cases");
      setCell("G1", "Study rate (/100k)");
      setCell("H1", "Ref rate (/100k)");
      setCell("I1", "Weighted study rate");
      setCell("J1", "Weighted ref rate");
      setCell("K1", "Expected cases (study)");

      // Age bands & base data
      for (let i = 0; i < ageBandsBase.length; i++) {
        const row = 2 + i;
        const band = ageBandsBase[i];
        setCell("A" + row, band.label);
        setCell("B" + row, band.stdPop, 0);
        setCell("C" + row, band.studyPop, 0);
        setCell("D" + row, band.studyCases, 0);
        setCell("E" + row, band.refPop, 0);
        setCell("F" + row, band.refCases, 0);
      }

      setCell("A7", "Totals");
      setCell("A8", "Crude rate (/100k)");
      setCell("A9", "Directly std rate (/100k)");
      setCell("A10", "Indirect (study vs ref)");
    }

    function recalcAll() {
      const n = ageBandsBase.length;
      const bands = [];

      for (let i = 0; i < n; i++) {
        const row = 2 + i;
        const base = ageBandsBase[i];
        const stdPop = getEditableNumber("B" + row, base.stdPop); // could keep standard editable if desired
        const studyPop = getEditableNumber("C" + row, base.studyPop);
        const studyCases = getEditableNumber("D" + row, base.studyCases);
        const refPop = getEditableNumber("E" + row, base.refPop);
        const refCases = getEditableNumber("F" + row, base.refCases);
        bands.push({ ...base, stdPop, studyPop, studyCases, refPop, refCases });
        setCell("B" + row, stdPop, 0); // normalise formatting
      }

      // Totals
      let totalStd = 0;
      let totalStudyPop = 0;
      let totalStudyCases = 0;
      let totalRefPop = 0;
      let totalRefCases = 0;
      let totalExpected = 0;

      // Direct components (weighted rates)
      let directStudyASR = 0;
      let directRefASR = 0;

      for (let i = 0; i < n; i++) {
        const row = 2 + i;
        const band = bands[i];

        totalStd += band.stdPop;
        totalStudyPop += band.studyPop;
        totalStudyCases += band.studyCases;
        totalRefPop += band.refPop;
        totalRefCases += band.refCases;

        // Age-specific rates
        const studyRate = band.studyPop > 0 ? (band.studyCases / band.studyPop) * 100000 : 0;
        const refRate = band.refPop > 0 ? (band.refCases / band.refPop) * 100000 : 0;

        setCell("G" + row, studyRate, 1);
        setCell("H" + row, refRate, 1);

        const weight = totalStd > 0 ? band.stdPop / totalStd : 0;

        // Weighted rates for direct method
        const weightedStudy = studyRate * weight;
        const weightedRef = refRate * weight;
        setCell("I" + row, weightedStudy, 2);
        setCell("J" + row, weightedRef, 2);

        directStudyASR += weightedStudy;
        directRefASR += weightedRef;

        // Expected cases for indirect (apply reference age-specific rates to study pop)
        const expectedCases = band.studyPop * (refRate / 100000); // since refRate is per 100k
        setCell("K" + row, expectedCases, 1);
        totalExpected += expectedCases;
      }

      // Totals row
      setCell("B7", totalStd, 0);
      setCell("C7", totalStudyPop, 0);
      setCell("D7", totalStudyCases, 0);
      setCell("E7", totalRefPop, 0);
      setCell("F7", totalRefCases, 0);
      setCell("K7", totalExpected, 1);

      // Crude rates
      const crudeStudy = totalStudyPop > 0 ? (totalStudyCases / totalStudyPop) * 100000 : NaN;
      const crudeRef = totalRefPop > 0 ? (totalRefCases / totalRefPop) * 100000 : NaN;
      setCell("G8", isFinite(crudeStudy) ? crudeStudy : "", 1);
      setCell("H8", isFinite(crudeRef) ? crudeRef : "", 1);

      // Directly age-standardised rates (per 100k)
      setCell("I9", directStudyASR, 1);
      setCell("J9", directRefASR, 1);

      // Indirect standardisation: SMR and indirectly standardised rate
      const smr = totalExpected > 0 ? totalStudyCases / totalExpected : NaN;
      const indirectRate = isFinite(smr) && isFinite(crudeRef) ? smr * crudeRef : NaN;

      setCell("B10", "SMR study/ref");
      setCell("C10", isFinite(smr) ? smr : "", 2);
      setCell("D10", "Indirect rate (study)");
      setCell("E10", isFinite(indirectRate) ? indirectRate : "", 1);

      // Labels for clarity
      setCell("B8", "Study");
      setCell("H8", crudeRef ? formatNumber(crudeRef, 1) : "", 1);
      setCell("B9", "Study");
      setCell("F8", "Ref crude");
      setCell("F9", "Ref direct");

      // Summary
      const summary = document.getElementById("summary-box");
      summary.innerHTML =
        "<strong>Crude rate – study:</strong> " + (isFinite(crudeStudy) ? formatNumber(crudeStudy, 1) : "NA") +
        " per 100,000; <strong>reference:</strong> " + (isFinite(crudeRef) ? formatNumber(crudeRef, 1) : "NA") + " per 100,000.<br>" +
        "<strong>Directly standardised rate – study:</strong> " + formatNumber(directStudyASR, 1) +
        " per 100,000; <strong>reference:</strong> " + formatNumber(directRefASR, 1) + " per 100,000.<br>" +
        "<strong>SMR (study vs reference):</strong> " + (isFinite(smr) ? formatNumber(smr, 2) : "NA") +
        "; <strong>indirectly standardised rate – study:</strong> " +
        (isFinite(indirectRate) ? formatNumber(indirectRate, 1) : "NA") + " per 100,000.";
    }

    // Steps: direct vs indirect
    const steps = [
      {
        title: "Step 1 – Understand the data and the goal",
        description:
          "We have age-specific cancer cases and populations for a <strong>study region</strong> and a <strong>reference region</strong>, " +
          "plus a chosen <strong>standard population</strong> (column B). We want to compare the study region to the reference region " +
          "while adjusting for different age structures.",
        formulas: [
          "Think of the 2 key questions:",
          "1) Direct method: What would each region’s rate be if they both had the same age structure (the standard pop in column B)?",
          "2) Indirect method: Given the reference region’s age-specific rates, are there more or fewer cases in the study region than expected?"
        ],
        highlight: ["A1","B1","C1","D1","E1","F1","A2","A3","A4","A5","A6","C2","D2","E2","F2","C3","D3","E3","F3","C4","D4"],
        question:
          "Just by eye, does the study region appear older or younger than the reference region (compare columns C and E across age bands)? " +
          "How might that affect crude (overall) rates?",
        explanation:
          "Cancer risk increases with age. If one region has more older people, it may have a higher crude rate even if underlying " +
          "age-specific risks are similar. Age standardisation (direct or indirect) separates differences in age structure from differences in risk."
      },
      {
        title: "Step 2 – Compute age-specific rates in study and reference regions",
        description:
          "Age-specific incidence rates are the starting point for both methods. We calculate them for the study region and for the reference region.",
        formulas: [
          "In Excel, label cells as:",
          "Study population: C2:C6; Study cases: D2:D6",
          "Ref population:   E2:E6; Ref cases:   F2:F6",
          "",
          "Age-specific rates (per 100,000):",
          "In G2 type: =D2/C2*100000  and copy down to G6 (study rates).",
          "In H2 type: =F2/E2*100000  and copy down to H6 (reference rates)."
        ],
        highlight: ["C2","D2","E2","F2","G2","H2","C3","D3","E3","F3","G3","H3","C4","D4","E4","F4","G4","H4"],
        question:
          "Compare the age-specific rates in G2:G6 (study) with H2:H6 (reference). " +
          "In which age groups is the study region higher, and in which is it lower?",
        explanation:
          "Age-specific rates are the building blocks. Direct standardisation will apply the study and reference age-specific " +
          "rates to the same standard population. Indirect standardisation will apply the <em>reference</em> rates to the study population " +
          "to calculate expected cases."
      },
      {
        title: "Step 3 – Direct standardisation (apply rates to a standard population)",
        description:
          "Direct standardisation answers: ‘What would the rate be in each region if they both had the same age structure (the standard pop in column B)?’",
        formulas: [
          "First compute the total standard population:",
          "In B7 type: =SUM(B2:B6)",
          "",
          "Then compute the weights (proportions) if you want to see them explicitly:",
          "In a new helper column (say L2): =B2/$B$7  and copy down.",
          "",
          "In this sheet, weighted rates are stored directly:",
          "In I2 type: =G2*B2/$B$7  and copy down to I6 (weighted study rates).",
          "In J2 type: =H2*B2/$B$7  and copy down to J6 (weighted ref rates).",
          "",
          "Then sum to get directly age-standardised rates:",
          "In I9 type: =SUM(I2:I6)   (study, direct).",
          "In J9 type: =SUM(J2:J6)   (reference, direct)."
        ],
        highlight: ["B2","B3","B4","B5","B6","B7","G2","H2","I2","J2","I3","J3","I4","J4","I5","J5","I6","J6","I9","J9"],
        question:
          "Compare the crude rates in row 8 with the directly standardised rates in row 9. " +
          "Did the difference between the study and reference regions get bigger, smaller, or stay similar after direct standardisation?",
        explanation:
          "Direct standardisation uses each region’s age-specific rates and applies them to a common standard population. " +
          "It is best when you have stable age-specific rates (enough events in each age band) in every group you want to compare."
      },
      {
        title: "Step 4 – Indirect standardisation (SMR and indirectly standardised rate)",
        description:
          "Indirect standardisation answers: ‘Given the reference region’s age-specific rates, how many cases would we expect in the study region? " +
          "How does that compare with what we actually observed?’",
        formulas: [
          "Expected cases in the study region (applying ref rates to study population):",
          "Recall: ref rates H2:H6 are per 100,000.",
          "",
          "In K2 type: =C2*H2/100000  and copy down to K6.",
          "In K7 type: =SUM(K2:K6)   (total expected cases in study).",
          "",
          "Observed total cases in study are already in D7:",
          "In D7 type: =SUM(D2:D6)",
          "",
          "Standardised Mortality Ratio (SMR) or Standardised Incidence Ratio:",
          "In C10 type: =D7/K7   (SMR, study vs reference).",
          "",
          "Indirectly standardised rate for the study region:",
          "In E10 type: =C10*H8",
          "where H8 is the crude rate in the reference region."
        ],
        highlight: ["C2","H2","K2","C3","H3","K3","C4","H4","K4","C5","H5","K5","C6","H6","K6","K7","D7","C10","E10"],
        question:
          "Is the SMR in C10 greater than 1, less than 1, or about 1? " +
          "How does the indirectly standardised rate in E10 compare to the crude and directly standardised rates?",
        explanation:
          "Indirect standardisation uses the reference region’s age-specific rates as the standard. " +
          "We apply those to the study population to calculate expected cases, then compare observed vs expected. " +
          "It is especially useful for small populations where study-region age-specific rates would be unstable, " +
          "but you have good, stable rates available from a larger reference population."
      },
      {
        title: "Step 5 – Compare direct vs indirect standardisation",
        description:
          "Now you have crude rates, directly standardised rates, and indirectly standardised rates for the study region. " +
          "Try changing the age distribution or the age-specific case counts and see what happens.",
        formulas: [
          "Key cells:",
          "Crude rate – study: G8  (D7/C7*100000)",
          "Crude rate – reference: H8  (F7/E7*100000)",
          "Directly standardised – study: I9 = SUM(I2:I6)",
          "Directly standardised – reference: J9 = SUM(J2:J6)",
          "SMR (study vs ref): C10 = D7/K7",
          "Indirectly standardised rate – study: E10 = C10*H8"
        ],
        highlight: ["G8","H8","I9","J9","C10","E10"],
        question:
          "After editing the data, can you find a situation where the crude rates differ substantially, " +
          "but the directly and indirectly standardised comparisons suggest little or no difference in underlying risk? " +
          "When might you prefer to use the direct method, and when the indirect method?",
        explanation:
          "Direct standardisation compares groups on the same external standard population and is ideal when age-specific rates " +
          "are available and reasonably stable in all groups. Indirect standardisation (SMR) compares observed vs expected counts " +
          "using a common set of reference rates, and is often used for small study populations (e.g. specific occupations, hospitals). " +
          "Both methods aim to remove differences that are due purely to age structure, but they answer slightly different questions."
      }
    ];

    let currentStepIndex = 0;

    function clearHighlights() {
      Object.values(cells).forEach(td => td.classList.remove("highlight"));
    }

    function renderStep(index) {
      currentStepIndex = index;
      const step = steps[index];

      document.getElementById("step-title").innerHTML = step.title;
      document.getElementById("step-description").innerHTML = step.description;

      const formulaList = document.getElementById("formula-list");
      formulaList.innerHTML = "";
      if (step.formulas && step.formulas.length) {
        step.formulas.forEach(text => {
          const li = document.createElement("li");
          li.textContent = text;
          formulaList.appendChild(li);
        });
        document.getElementById("formula-box").style.display = "block";
      } else {
        document.getElementById("formula-box").style.display = "none";
      }

      document.getElementById("question-text").textContent = step.question || "";
      document.getElementById("reflection").placeholder =
        step.question ? "Write your answer or interpretation for: \"" + step.question + "\"" : "Write your thoughts here...";

      document.getElementById("explanation-text").innerHTML = step.explanation || "";

      clearHighlights();
      if (step.highlight) {
        step.highlight.forEach(id => {
          const td = cells[id];
          if (td) td.classList.add("highlight");
        });
      }

      document.getElementById("step-indicator").textContent =
        "Step " + (index + 1) + " of " + steps.length;

      document.getElementById("prev-btn").disabled = index === 0;
      document.getElementById("next-btn").disabled = index === steps.length - 1;
    }

    function attachEventHandlers() {
      document.getElementById("prev-btn").addEventListener("click", () => {
        if (currentStepIndex > 0) {
          recalcAll();
          renderStep(currentStepIndex - 1);
        }
      });

      document.getElementById("next-btn").addEventListener("click", () => {
        if (currentStepIndex < steps.length - 1) {
          recalcAll();
          renderStep(currentStepIndex + 1);
        }
      });

      document.getElementById("recalc-btn").addEventListener("click", () => {
        recalcAll();
      });

      // Validate numeric editable cells on blur
      document
        .querySelectorAll(".numeric-editable .cell-content[contenteditable='true']")
        .forEach(span => {
          span.addEventListener("blur", () => {
            const raw = span.textContent.replace(/,/g, "").trim();
            if (raw === "") return; // Empty -> will use fallback on recalc
            const val = parseFloat(raw);
            if (isNaN(val) || val < 0) {
              span.textContent = "";
            } else {
              span.textContent = formatNumber(val, 0);
            }
          });
        });
    }

    window.addEventListener("DOMContentLoaded", () => {
      cacheCells();
      initialiseSheet();
      recalcAll();
      attachEventHandlers();
      renderStep(0);
    });
  })();
</script>
</body>
</html>
