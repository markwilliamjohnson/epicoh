<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TRIPOD-AI Interactive Explorer (Light Theme)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-page: #f5f5f7;
      --bg-card: #ffffff;
      --border-subtle: #e5e7eb;
      --shadow-soft: 0 8px 20px rgba(15, 23, 42, 0.06);
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 1024px) {
      .app-container {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .subtitle {
      font-size: 0.84rem;
      color: var(--text-muted);
    }

    .pill {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 3px 8px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #4b5563;
      background: #f9fafb;
      white-space: nowrap;
    }

    .project-form {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 900px) {
      .project-form {
        grid-template-columns: 1fr;
      }
    }

    .field-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .text-input,
    .text-area {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: var(--text-main);
      padding: 6px 8px;
      font-size: 0.85rem;
      font-family: inherit;
    }

    .text-input::placeholder,
    .text-area::placeholder {
      color: #9ca3af;
    }

    .text-input:focus,
    .text-area:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .text-area {
      min-height: 80px;
      resize: vertical;
      grid-column: 1 / -1;
    }

    .section-title {
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title .icon {
      display: inline-flex;
      width: 18px;
      height: 18px;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 0.7rem;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .checklist {
      margin-top: 4px;
      max-height: calc(100vh - 220px);
      overflow: auto;
      padding-right: 4px;
    }

    .item-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 8px 9px 9px;
      margin-bottom: 8px;
      transition: box-shadow 0.12s ease-out, border-color 0.12s ease-out, transform 0.12s ease-out, background 0.12s;
    }

    .item-card.tour-highlight {
      border-color: #f59e0b;
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.6), 0 8px 18px rgba(0, 0, 0, 0.06);
      background: #fffbeb;
      transform: translateY(-1px);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .item-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .item-tag {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      white-space: nowrap;
    }

    .item-description {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .slider-label-block {
      flex: 1.3;
      min-width: 0;
    }

    .slider-label {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .slider-value {
      width: 56px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-size: 0.8rem;
      color: #111827;
    }

    input[type="range"] {
      flex: 2;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: #e5e7eb;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 2px var(--accent-soft);
      cursor: pointer;
      margin-top: -6px;
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 2px var(--accent-soft);
      cursor: pointer;
    }

    input[type="range"]::-moz-range-track {
      height: 4px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .comment-input {
      width: 100%;
      resize: vertical;
      min-height: 34px;
      max-height: 80px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: var(--text-main);
      font-size: 0.8rem;
      padding: 4px 6px;
      font-family: inherit;
      margin-bottom: 4px;
    }

    .comment-input::placeholder {
      color: #9ca3af;
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: #ffffff;
    }

    details {
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    details summary {
      list-style: none;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details summary::before {
      content: "▸";
      display: inline-block;
      margin-right: 4px;
      font-size: 0.7rem;
    }

    details[open] summary::before {
      content: "▾";
    }

    .results-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .result-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      background: #ffffff;
    }

    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .result-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .result-mean {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .distribution-row {
      display: grid;
      grid-template-columns: 0.9fr 2.4fr 0.7fr;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .distribution-row:last-child {
      margin-bottom: 0;
    }

    .dist-label {
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .dist-bar-container {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      overflow: hidden;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }

    .dist-bar-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent-soft), var(--accent));
      transition: width 120ms ease-out;
    }

    .dist-value {
      font-size: 0.76rem;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: #111827;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .legend-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    .summary-text {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 8px;
      line-height: 1.4;
    }

    .summary-highlight {
      color: #111827;
      font-weight: 500;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #4b5563;
      background: #f9fafb;
    }

    .badge.good {
      border-color: #22c55e;
      color: #166534;
      background: #dcfce7;
    }

    .badge.warn {
      border-color: #f97316;
      color: #9a3412;
      background: #ffedd5;
    }

    .badge.risk {
      border-color: #ef4444;
      color: #991b1b;
      background: #fee2e2;
    }

    .export-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .export-button,
    .tour-button,
    .tour-nav-btn {
      border-radius: 999px;
      border: 1px solid var(--accent);
      padding: 6px 12px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      background: #ffffff;
      color: var(--accent);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tour-button {
      padding: 4px 10px;
      font-size: 0.72rem;
    }

    .tour-nav-btn {
      padding: 3px 10px;
      font-size: 0.7rem;
    }

    .export-button:hover,
    .tour-button:hover,
    .tour-nav-btn:hover {
      background: var(--accent);
      color: #ffffff;
    }

    .export-button:active,
    .tour-button:active,
    .tour-nav-btn:active {
      transform: translateY(1px);
    }

    .tour-nav-btn.secondary {
      border-color: #d1d5db;
      color: #4b5563;
      background: #f9fafb;
    }

    .tour-nav-btn.secondary:hover {
      background: #e5e7eb;
      color: #111827;
    }

    .export-box {
      width: 100%;
      min-height: 150px;
      max-height: 220px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #111827;
      font-size: 0.8rem;
      padding: 6px 8px;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre;
    }

    .export-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .uncertainty-block {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px dashed #e5e7eb;
      background: #f9fafb;
    }

    .uncertainty-label {
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .uncertainty-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .uncertainty-value {
      font-size: 0.8rem;
      font-variant-numeric: tabular-nums;
      color: #111827;
      min-width: 60px;
      text-align: right;
    }

    /* Guided tour panel */
    .tour-panel {
      margin-top: 10px;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .tour-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .tour-title {
      font-size: 0.86rem;
      font-weight: 600;
    }

    .tour-step-indicator {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .tour-body {
      font-size: 0.78rem;
      color: var(--text-main);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .tour-body p {
      margin: 2px 0;
    }

    .tour-body-cta {
      font-size: 0.76rem;
      color: #374151;
    }

    .tour-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
    }

    .tour-nav-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .tour-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- LEFT: Project & TRIPOD-AI checklist -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">TRIPOD-AI Interactive Explorer</div>
          <div class="subtitle">
            Use the TRIPOD-AI checklist to stress-test your AI/ML prediction project, one item at a time.
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          <span class="pill">Project · Checklist · Reflection</span>
          <button id="tourStartButton" class="tour-button">
            <span>★</span> Start guided tour
          </button>
        </div>
      </div>

      <div class="project-form">
        <div>
          <div class="field-label">Project title</div>
          <input id="projectTitle" class="text-input" placeholder="e.g. Sepsis early-warning model in ICU" />
        </div>
        <div>
          <div class="field-label">Project type / setting</div>
          <input id="projectType" class="text-input" placeholder="e.g. Prognostic, hospital, ICU" />
        </div>
        <div>
          <div class="field-label">Lead / team</div>
          <input id="projectTeam" class="text-input" placeholder="e.g. Clinical AI lab, cardiology dept." />
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="field-label">Brief description of the AI/ML prediction model study</div>
          <textarea
            id="projectSummary"
            class="text-area"
            placeholder="In a few sentences: target population, outcome, predictors, main AI/ML approach, and intended use."
          ></textarea>
        </div>
      </div>

      <div class="section-title">
        <span class="icon">✓</span> TRIPOD-AI checklist mapped to your project
      </div>

      <div class="checklist" id="checklistContainer">
        <!-- Populated via JS -->
      </div>
    </section>

    <!-- RIGHT: Distributions + Uncertainty + Guided tour panel + Export -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Outcome Distributions from Your TRIPOD-AI Profile</div>
          <div class="subtitle">
            As you move the sliders, we estimate how your reporting profile affects viability, feasibility, ethics and sustainability.
          </div>
        </div>
        <span class="pill">Viability · Feasibility · Ethics · Sustainability</span>
      </div>

      <div class="uncertainty-block">
        <div class="uncertainty-label">
          Overall confidence in your TRIPOD-AI ratings
          <span style="color:#9ca3af;">(0 = very unsure, 100 = very confident)</span>
        </div>
        <div class="uncertainty-row">
          <input type="range" min="0" max="100" value="60" id="uncertaintyGlobal" />
          <div class="uncertainty-value" id="uncertaintyValue"></div>
        </div>
      </div>

      <!-- Guided tour panel -->
      <div class="tour-panel" id="tourPanel">
        <div class="tour-header">
          <div class="tour-title">Guided tour: TRIPOD-AI in practice</div>
          <div class="tour-step-indicator" id="tourStepIndicator">
            Tour not started
          </div>
        </div>
        <div class="tour-body" id="tourBody">
          <p>
            Click <strong>“Start guided tour”</strong> on the left. We’ll walk through selected
            TRIPOD-AI items, highlight them in the checklist, and invite short reflections.
          </p>
        </div>
        <div class="tour-controls">
          <div class="tour-nav-group">
            <button id="tourPrev" class="tour-nav-btn secondary" disabled>Back</button>
            <button id="tourNext" class="tour-nav-btn">Next</button>
          </div>
          <div class="tour-nav-group">
            <button id="tourEnd" class="tour-nav-btn secondary">End tour</button>
            <div class="tour-hint" id="tourHint">Tour is idle – press “Start guided tour”.</div>
          </div>
        </div>
      </div>

      <div class="results-grid" id="resultsGrid">
        <!-- Populated via JS -->
      </div>

      <div class="legend">
        <div class="legend-item">
          <span class="legend-dot"></span>
          <span>Bar length = probability in that band</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="opacity:0.4;"></span>
          <span>Bands: Very Low, Low, Medium, High, Very High</span>
        </div>
      </div>

      <div class="summary-text" id="summaryText"></div>

      <div class="export-controls">
        <button id="exportButton" class="export-button">
          <span>⇩</span> Export JSON snapshot
        </button>
        <div class="export-hint">
          Export all TRIPOD-AI sliders, comments, project info and current outcome distributions.
        </div>
      </div>

      <textarea
        id="exportBox"
        class="export-box"
        placeholder="Your exported JSON will appear here after export. You can also download it as a file."
        readonly
      ></textarea>
    </section>
  </div>

  <script>
    // --- TRIPOD-AI items (same content as before, adapted for this UI) ---

    const TRIPOD_ITEMS = [
      // Title & Abstract
      {
        id: "title_identification",
        section: "Title & Abstract",
        tag: "Title",
        label: "Does the title clearly identify an AI/ML prediction model study?",
        prompt: "Title states this is a prediction model using AI/ML and mentions target population and outcome.",
        why: "Readers and indexers should immediately recognise that this is an AI/ML prediction model study and what population/outcome it concerns."
      },
      {
        id: "abstract_structure",
        section: "Title & Abstract",
        tag: "Abstract",
        label: "Is the abstract structured and complete?",
        prompt: "Summary includes design, data source, population, predictors, AI/ML methods, performance, and implications.",
        why: "Editors, reviewers, and busy clinicians often only see the abstract. It should summarise key TRIPOD-AI elements so the study can be appraised at a glance."
      },

      // Background & Objectives
      {
        id: "background_rationale",
        section: "Background & Objectives",
        tag: "Background",
        label: "Is the clinical/decision context and rationale clear?",
        prompt: "Explains why a prediction model is needed, current practice limitations, and how AI/ML might help.",
        why: "Clear rationale avoids ‘solutionism’. It ties the AI system to real decision points and unmet needs in practice."
      },
      {
        id: "objectives_specified",
        section: "Background & Objectives",
        tag: "Objectives",
        label: "Are the study objectives precisely defined?",
        prompt: "States whether the study develops, validates, updates, or compares prediction models, and what the primary objective is.",
        why: "Ambiguous objectives make it hard to judge if methods, analyses, and conclusions are aligned and complete."
      },

      // Data, participants, predictors & outcome
      {
        id: "source_of_data",
        section: "Data & Participants",
        tag: "Data source",
        label: "Is the data source clearly described?",
        prompt: "Data origin (e.g. EHR, registry, trial), time period, setting, and how records were obtained.",
        why: "Data provenance affects bias, generalisability, and feasibility of implementing the model elsewhere."
      },
      {
        id: "participants_criteria",
        section: "Data & Participants",
        tag: "Participants",
        label: "Are eligibility criteria and settings reported?",
        prompt: "Inclusion/exclusion criteria, recruitment setting, and whether diagnostic or prognostic context is clear.",
        why: "Prediction models can only be generalised to populations similar to those included; vague criteria hide spectrum bias."
      },
      {
        id: "outcome_definition",
        section: "Predictors & Outcome",
        tag: "Outcome",
        label: "Is the predicted outcome clearly defined and measured?",
        prompt: "Outcome definition, timing, measurement methods, and who/what ascertained the outcome.",
        why: "Poorly defined outcomes undermine both model training and later clinical use; misclassification risk must be assessable."
      },
      {
        id: "predictors_definition",
        section: "Predictors & Outcome",
        tag: "Predictors",
        label: "Are predictors (features) clearly defined and justified?",
        prompt: "List of predictors, how and when measured, and any AI-specific feature representations or embeddings.",
        why: "Transparency about predictors is critical for bias assessment, feasibility of collection, and understanding model behaviour."
      },
      {
        id: "sample_size",
        section: "Data & Participants",
        tag: "Sample size",
        label: "Is sample size and events-per-predictor justified?",
        prompt: "Rationale for sample size, events-per-parameter, or data points per model complexity for AI architectures.",
        why: "Underpowered training or validation leads to optimistic performance estimates and unstable models."
      },
      {
        id: "missing_data",
        section: "Data & Participants",
        tag: "Missing data",
        label: "Is handling of missing data described?",
        prompt: "Extent of missingness, patterns, and methods used (e.g. imputation, modelling missingness, exclusions).",
        why: "Incomplete and poorly handled data can bias predictions and degrade performance when deployed."
      },

      // Model development: AI specifics
      {
        id: "model_specification_ai",
        section: "Model Development & AI",
        tag: "Model",
        label: "Is the AI/ML model architecture and specification reported?",
        prompt: "Model type(s), architecture, hyperparameters, and any ensembling or stacking.",
        why: "Readers need enough detail to understand model capacity, complexity, and potential overfitting risks."
      },
      {
        id: "training_procedure",
        section: "Model Development & AI",
        tag: "Training",
        label: "Is the training and optimisation process described?",
        prompt: "Train/validation/test splits, cross-validation, early stopping, and optimisation criteria.",
        why: "Opaque training procedures make performance claims hard to reproduce and interpret."
      },
      {
        id: "feature_engineering",
        section: "Model Development & AI",
        tag: "Features",
        label: "Is feature engineering and preprocessing transparent?",
        prompt: "Scaling, encoding, temporal aggregation, dimensionality reduction, and AI-specific pipelines.",
        why: "Preprocessing choices can heavily influence bias, robustness, and replicability across sites."
      },
      {
        id: "internal_validation",
        section: "Model Development & AI",
        tag: "Validation",
        label: "Is internal validation robust?",
        prompt: "Resampling (bootstrapping, cross-validation), temporal splits, or nested validation procedures.",
        why: "Without robust internal validation, apparent performance may just reflect overfitting to quirks of the dataset."
      },

      // Performance, uncertainty & explainability
      {
        id: "performance_metrics",
        section: "Performance, Uncertainty & Explainability",
        tag: "Performance",
        label: "Are appropriate performance measures reported?",
        prompt: "Discrimination (e.g. AUC), calibration, and decision-analytic measures, with confidence intervals.",
        why: "Multiple complementary metrics are needed to judge usefulness; a single AUC is rarely enough."
      },
      {
        id: "uncertainty_reporting",
        section: "Performance, Uncertainty & Explainability",
        tag: "Uncertainty",
        label: "Is statistical uncertainty adequately reported?",
        prompt: "Confidence intervals, prediction intervals, bootstrap variability, or Bayesian estimates.",
        why: "Point estimates alone give a false sense of certainty; uncertainty is crucial for safe decision-making."
      },
      {
        id: "explainability_methods",
        section: "Performance, Uncertainty & Explainability",
        tag: "Explainability",
        label: "Is model behaviour explained in a meaningful way?",
        prompt: "Global and local explainability methods, stability checks, and how explanations are used in practice.",
        why: "Clinicians and patients need to understand model behaviour to trust and appropriately contest predictions."
      },
      {
        id: "subgroup_performance",
        section: "Performance, Uncertainty & Explainability",
        tag: "Subgroups",
        label: "Are subgroup and fairness analyses reported?",
        prompt: "Performance by key demographic/clinical subgroups, and discussion of any disparities.",
        why: "Systematic underperformance in specific groups may entrench inequities and must be visible and addressed."
      },

      // Results
      {
        id: "participant_flow",
        section: "Results",
        tag: "Flow",
        label: "Is participant/data flow described?",
        prompt: "Flow diagram or description of included/excluded records and reasons.",
        why: "Transparency about exclusions helps readers judge selection bias and real-world applicability."
      },
      {
        id: "model_presentation",
        section: "Results",
        tag: "Presentation",
        label: "Is the final model presented clearly?",
        prompt: "Coefficients or algorithm description, thresholds, and how to generate predictions from raw inputs.",
        why: "Without clear presentation, the model cannot be independently implemented, validated, or scrutinised."
      },
      {
        id: "result_clarity",
        section: "Results",
        tag: "Results detail",
        label: "Are main results and comparisons clearly summarised?",
        prompt: "Key performance, calibration, and comparisons against baselines or existing tools are reported and interpretable.",
        why: "Dense or selective reporting hides weaknesses and makes it hard for decision-makers to judge value."
      },

      // Discussion & other information
      {
        id: "limitations_discussed",
        section: "Discussion & Other Information",
        tag: "Limitations",
        label: "Are limitations and risks explicitly discussed?",
        prompt: "Recognises dataset limitations, model assumptions, potential harms, and generalisability issues.",
        why: "Honest discussion of weaknesses helps others avoid misuse and misinterpretation of the model."
      },
      {
        id: "clinical_utility",
        section: "Discussion & Other Information",
        tag: "Use & impact",
        label: "Is the intended use and clinical/operational impact discussed?",
        prompt: "How and where the model should be used, how decisions may change, and potential benefits and harms.",
        why: "Without a clear use-case narrative, promising models often fail at the point of implementation."
      },
      {
        id: "governance_monitoring",
        section: "Discussion & Other Information",
        tag: "Governance",
        label: "Are governance, monitoring and updating plans described?",
        prompt: "Plans for monitoring performance, recalibration, updating, and handling incidents or drift.",
        why: "AI systems live in changing environments; governance and monitoring are essential for sustainability and safety."
      },
      {
        id: "data_code_availability",
        section: "Discussion & Other Information",
        tag: "Open science",
        label: "Are data, code or model artifacts available (where possible)?",
        prompt: "Statements about availability of code, trained models, or synthetic data; justification if not shared.",
        why: "Sharing resources supports independent validation, learning across sites, and more trustworthy ecosystems."
      },
      {
        id: "registration_protocol",
        section: "Discussion & Other Information",
        tag: "Registration",
        label: "Is there a protocol or registration entry?",
        prompt: "Registration on a repository or protocol publication, and disclosure of deviations.",
        why: "Prospective registration and protocols reduce selective reporting and analytic flexibility."
      }
    ];

    const OUTCOMES = [
      { key: "viability", label: "Viability" },
      { key: "feasibility", label: "Feasibility" },
      { key: "ethics", label: "Ethics" },
      { key: "sustainability", label: "Sustainability" }
    ];

    const BANDS = [
      { key: "veryLow", label: "Very Low", center: 0.1 },
      { key: "low", label: "Low", center: 0.3 },
      { key: "medium", label: "Medium", center: 0.5 },
      { key: "high", label: "High", center: 0.7 },
      { key: "veryHigh", label: "Very High", center: 0.9 }
    ];

    const TOUR_STEPS = [
      {
        itemId: "background_rationale",
        title: "Start with the ‘why’ of your project",
        text: [
          "TRIPOD-AI begins with a clear clinical or decision rationale.",
          "Ask: why is a prediction model needed here, and why AI/ML rather than simpler tools?"
        ],
        cta: "Read the card, adjust the slider to reflect how clearly your rationale is written, and jot down one thing you could explain more clearly."
      },
      {
        itemId: "source_of_data",
        title: "Make your data provenance transparent",
        text: [
          "The source of data shapes bias and generalisability.",
          "Being explicit about where data come from is crucial for readers deciding if they can trust or reuse your model."
        ],
        cta: "Describe your main data source in the comment box. Then adjust the slider based on how complete that description is in your current materials."
      },
      {
        itemId: "model_specification_ai",
        title: "Tell the story of your AI/ML model",
        text: [
          "TRIPOD-AI expects enough model detail for others to understand capacity and overfitting risks.",
          "Think about architecture, hyperparameters, and any ensembling."
        ],
        cta: "List your main model type(s) and key hyperparameters in the comments. Move the slider to match how reproducible an external team would find your description."
      },
      {
        itemId: "internal_validation",
        title: "Interrogate your internal validation",
        text: [
          "Apparent performance can be misleading without robust internal validation.",
          "Resampling, temporal splits, or nested validation reduce optimism in performance estimates."
        ],
        cta: "Briefly note how you validated your model (e.g., k-fold CV, temporal split). Adjust the slider to reflect how robust this looks through a TRIPOD-AI lens."
      },
      {
        itemId: "subgroup_performance",
        title: "Look for fairness and subgroup performance",
        text: [
          "Subgroup analyses reveal who benefits and who might be harmed.",
          "TRIPOD-AI encourages explicit reporting of performance across key demographic/clinical groups."
        ],
        cta: "Identify at least one vulnerable or key subgroup in your setting and note whether you have performance estimates for them."
      },
      {
        itemId: "explainability_methods",
        title: "Explainability for humans, not just plots",
        text: [
          "Explainability is only useful if it fits real decision workflows.",
          "Think about both technical methods (e.g. SHAP) and how they are communicated to clinicians or end-users."
        ],
        cta: "Describe how an individual clinician or user would actually see explanations. Then adjust the slider to match reality."
      },
      {
        itemId: "governance_monitoring",
        title: "Plan for life after publication",
        text: [
          "TRIPOD-AI emphasises governance and monitoring for real-world AI.",
          "Deployment is not the end; models will drift, contexts will change, incidents may occur."
        ],
        cta: "Write down who is accountable for monitoring this model after deployment and how often performance will be checked."
      },
      {
        itemId: "data_code_availability",
        title: "Think about openness and reuse",
        text: [
          "Data, code and model sharing (where permissible) enable independent validation.",
          "Even if full sharing is impossible, clear statements about what is shareable matter."
        ],
        cta: "Note what you realistically could share (code, model weights, synthetic data) and what you cannot share and why."
      }
    ];

    let lastOutcomeSummary = null;
    let tourIndex = -1;
    let tourActive = false;

    function clamp01(x) {
      return Math.min(1, Math.max(0, x));
    }

    function computeDistribution(mean, confidence) {
      mean = clamp01(mean);
      const c = clamp01(confidence);
      const sigma = 0.4 - 0.22 * c; // high confidence -> narrower

      const probs = [];
      let sum = 0;
      for (const band of BANDS) {
        const z = (band.center - mean) / sigma;
        const density = Math.exp(-0.5 * z * z);
        probs.push(density);
        sum += density;
      }
      if (sum <= 0) return BANDS.map(() => 1 / BANDS.length);
      return probs.map(p => p / sum);
    }

    function expectedValueFromDistribution(dist) {
      let ev = 0;
      for (let i = 0; i < BANDS.length; i++) {
        ev += BANDS[i].center * dist[i];
      }
      return ev;
    }

    function renderChecklist() {
      const container = document.getElementById("checklistContainer");
      container.innerHTML = "";

      const sections = {};
      TRIPOD_ITEMS.forEach(item => {
        if (!sections[item.section]) sections[item.section] = [];
        sections[item.section].push(item);
      });

      Object.keys(sections).forEach(sectionName => {
        const sectionHeader = document.createElement("div");
        sectionHeader.className = "section-title";
        sectionHeader.innerHTML = `<span class="icon">${sectionName[0]}</span> ${sectionName}`;
        container.appendChild(sectionHeader);

        sections[sectionName].forEach(item => {
          const card = document.createElement("article");
          card.className = "item-card";
          card.dataset.itemId = item.id;

          const header = document.createElement("div");
          header.className = "item-header";

          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = item.label;

          const tag = document.createElement("div");
          tag.className = "item-tag";
          tag.textContent = item.tag;

          header.appendChild(title);
          header.appendChild(tag);

          const description = document.createElement("div");
          description.className = "item-description";
          description.textContent = item.prompt;

          const sliderRow = document.createElement("div");
          sliderRow.className = "slider-row";

          const sliderLabelBlock = document.createElement("div");
          sliderLabelBlock.className = "slider-label-block";

          const sliderLabel = document.createElement("div");
          sliderLabel.className = "slider-label";
          sliderLabel.textContent = "0 = not addressed  •  100 = fully addressed in current materials";

          sliderLabelBlock.appendChild(sliderLabel);

          const slider = document.createElement("input");
          slider.type = "range";
          slider.min = "0";
          slider.max = "100";
          slider.value = "50";
          slider.dataset.itemId = item.id;

          const value = document.createElement("div");
          value.className = "slider-value";
          value.id = `value_${item.id}`;
          value.textContent = " 50";

          slider.addEventListener("input", () => {
            value.textContent = slider.value.toString().padStart(3, " ");
            updateDistributions();
          });

          sliderRow.appendChild(sliderLabelBlock);
          sliderRow.appendChild(slider);
          sliderRow.appendChild(value);

          const comment = document.createElement("textarea");
          comment.className = "comment-input";
          comment.id = `comment_${item.id}`;
          comment.placeholder = "Reflection: what’s already strong here, and what needs attention for this item in your project?";

          const details = document.createElement("details");
          const summary = document.createElement("summary");
          summary.textContent = "Why this TRIPOD-AI item matters";
          const p = document.createElement("p");
          p.textContent = item.why;
          details.appendChild(summary);
          details.appendChild(p);

          card.appendChild(header);
          card.appendChild(description);
          card.appendChild(sliderRow);
          card.appendChild(comment);
          card.appendChild(details);

          container.appendChild(card);
        });
      });
    }

    function readItemValues() {
      const values = {};
      TRIPOD_ITEMS.forEach(item => {
        const slider = document.querySelector(`input[type="range"][data-item-id="${item.id}"]`);
        const comment = document.getElementById(`comment_${item.id}`);
        const v = slider ? parseInt(slider.value, 10) || 0 : 0;
        const c = comment ? comment.value || "" : "";
        values[item.id] = { value: v, comment: c };
      });
      return values;
    }

    function computeOutcomeMeans(values) {
      function avg(ids) {
        if (!ids.length) return 0;
        let sum = 0;
        ids.forEach(id => {
          const v = values[id] ? values[id].value : 0;
          sum += v / 100;
        });
        return sum / ids.length;
      }

      const viability = avg([
        "background_rationale",
        "objectives_specified",
        "performance_metrics",
        "result_clarity",
        "clinical_utility",
        "registration_protocol"
      ]);

      const feasibility = avg([
        "source_of_data",
        "participants_criteria",
        "sample_size",
        "missing_data",
        "model_specification_ai",
        "training_procedure",
        "feature_engineering",
        "participant_flow",
        "model_presentation",
        "data_code_availability"
      ]);

      const ethics = avg([
        "outcome_definition",
        "predictors_definition",
        "subgroup_performance",
        "explainability_methods",
        "limitations_discussed",
        "governance_monitoring"
      ]);

      const sustainability = avg([
        "governance_monitoring",
        "data_code_availability",
        "registration_protocol",
        "clinical_utility",
        "background_rationale"
      ]);

      return {
        viability: clamp01(viability),
        feasibility: clamp01(feasibility),
        ethics: clamp01(ethics),
        sustainability: clamp01(sustainability)
      };
    }

    function classifyBadge(v, f, e, s) {
      const strong =
        v > 0.6 &&
        f > 0.6 &&
        e > 0.55 &&
        s > 0.55;
      const ethicallyRisky = e < 0.45 && s < 0.5;
      if (ethicallyRisky) {
        return { label: "Ethical / sustainability concerns to address", cls: "risk" };
      }
      if (strong) {
        return { label: "Reporting looks strong & balanced", cls: "good" };
      }
      return { label: "Mixed profile – useful starting point for improvement", cls: "warn" };
    }

    function updateUncertaintyLabel() {
      const slider = document.getElementById("uncertaintyGlobal");
      const label = document.getElementById("uncertaintyValue");
      const v = slider ? parseInt(slider.value, 10) || 0 : 0;
      label.textContent = `${v.toString().padStart(3, " ")} / 100`;
    }

    function updateDistributions() {
      const values = readItemValues();
      const outcomeMeans = computeOutcomeMeans(values);
      const confidence = (parseInt(document.getElementById("uncertaintyGlobal").value, 10) || 0) / 100;
      const resultsGrid = document.getElementById("resultsGrid");
      resultsGrid.innerHTML = "";

      const summary = {};

      OUTCOMES.forEach(outcome => {
        const mean = outcomeMeans[outcome.key];
        const dist = computeDistribution(mean, confidence);
        const ev = expectedValueFromDistribution(dist);
        summary[outcome.key] = { mean, dist, ev };

        const card = document.createElement("div");
        card.className = "result-card";

        const header = document.createElement("div");
        header.className = "result-header";

        const title = document.createElement("div");
        title.className = "result-title";
        title.textContent = outcome.label;

        const meanLabel = document.createElement("div");
        meanLabel.className = "result-mean";
        meanLabel.textContent = `Expected level: ${(ev * 100).toFixed(1)}%`;

        header.appendChild(title);
        header.appendChild(meanLabel);
        card.appendChild(header);

        BANDS.forEach((band, i) => {
          const prob = dist[i];
          const row = document.createElement("div");
          row.className = "distribution-row";

          const label = document.createElement("div");
          label.className = "dist-label";
          label.textContent = band.label;

          const barContainer = document.createElement("div");
          barContainer.className = "dist-bar-container";
          const barFill = document.createElement("div");
          barFill.className = "dist-bar-fill";
          barFill.style.width = `${(prob * 100).toFixed(1)}%`;
          barContainer.appendChild(barFill);

          const value = document.createElement("div");
          value.className = "dist-value";
          value.textContent = `${(prob * 100).toFixed(1)}%`;

          row.appendChild(label);
          row.appendChild(barContainer);
          row.appendChild(value);
          card.appendChild(row);
        });

        resultsGrid.appendChild(card);
      });

      lastOutcomeSummary = summary;

      const summaryEl = document.getElementById("summaryText");
      const v = summary.viability.ev;
      const f = summary.feasibility.ev;
      const e = summary.ethics.ev;
      const s = summary.sustainability.ev;

      const badge = classifyBadge(v, f, e, s);
      const confidenceVal = (parseInt(document.getElementById("uncertaintyGlobal").value, 10) || 0) / 100;

      summaryEl.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:4px;">
          <div class="badge ${badge.cls}">${badge.label}</div>
          <div class="badge">Confidence: ${(confidenceVal * 100).toFixed(0)}%</div>
        </div>
        <div>
          <span class="summary-highlight">Viability</span> ≈ ${(v * 100).toFixed(0)}%,
          <span class="summary-highlight">Feasibility</span> ≈ ${(f * 100).toFixed(0)}%,
          <span class="summary-highlight">Ethics</span> ≈ ${(e * 100).toFixed(0)}%,
          <span class="summary-highlight">Sustainability</span> ≈ ${(s * 100).toFixed(0)}%.
        </div>
        <div style="margin-top:4px;">
          Where scores are low or uncertainty is high, use the checklist (and guided tour) on the left to refine reporting and design decisions.
        </div>
      `;
    }

    function exportJson() {
      const itemValues = readItemValues();
      const project = {
        title: document.getElementById("projectTitle").value || "",
        type: document.getElementById("projectType").value || "",
        team: document.getElementById("projectTeam").value || "",
        summary: document.getElementById("projectSummary").value || ""
      };

      const confidence = (parseInt(document.getElementById("uncertaintyGlobal").value, 10) || 0) / 100;

      const tripodAnswers = {};
      TRIPOD_ITEMS.forEach(item => {
        tripodAnswers[item.id] = {
          label: item.label,
          section: item.section,
          tag: item.tag,
          value: itemValues[item.id].value,
          comment: itemValues[item.id].comment
        };
      });

      const outcomes = lastOutcomeSummary
        ? Object.fromEntries(
            Object.entries(lastOutcomeSummary).map(([key, val]) => [
              key,
              {
                mean: val.mean,
                expectedValue: val.ev,
                distributionBands: BANDS.map((b, i) => ({
                  bandKey: b.key,
                  bandLabel: b.label,
                  probability: val.dist[i]
                }))
              }
            ])
          )
        : null;

      const snapshot = {
        generatedAt: new Date().toISOString(),
        project,
        tripodAI: {
          confidence,
          items: tripodAnswers,
          outcomes
        }
      };

      const jsonText = JSON.stringify(snapshot, null, 2);
      const exportBox = document.getElementById("exportBox");
      exportBox.value = jsonText;

      const blob = new Blob([jsonText], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "tripod_ai_explorer_snapshot.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Guided tour logic
    function clearTourHighlight() {
      const highlighted = document.querySelector(".item-card.tour-highlight");
      if (highlighted) highlighted.classList.remove("tour-highlight");
    }

    function focusTourItem(itemId) {
      clearTourHighlight();
      const card = document.querySelector(`.item-card[data-item-id="${itemId}"]`);
      if (!card) return;
      card.classList.add("tour-highlight");
      card.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function updateTourUI() {
      const body = document.getElementById("tourBody");
      const indicator = document.getElementById("tourStepIndicator");
      const hint = document.getElementById("tourHint");
      const prevBtn = document.getElementById("tourPrev");
      const nextBtn = document.getElementById("tourNext");

      if (!tourActive || tourIndex < 0) {
        indicator.textContent = "Tour not started";
        body.innerHTML = `
          <p>
            Click <strong>“Start guided tour”</strong> on the left. We’ll walk you
            through selected TRIPOD-AI items, highlighting them in the checklist and
            inviting short reflections.
          </p>
        `;
        hint.textContent = "Tour is idle – press “Start guided tour”.";
        prevBtn.disabled = true;
        nextBtn.disabled = false;
        clearTourHighlight();
        return;
      }

      const step = TOUR_STEPS[tourIndex];
      indicator.textContent = `Step ${tourIndex + 1} of ${TOUR_STEPS.length}`;
      body.innerHTML = `
        <p><strong>${step.title}</strong></p>
        ${step.text.map(t => `<p>${t}</p>`).join("")}
        <p class="tour-body-cta">${step.cta}</p>
      `;
      hint.textContent = "The highlighted card on the left belongs to this step.";

      prevBtn.disabled = tourIndex === 0;
      nextBtn.disabled = tourIndex === TOUR_STEPS.length - 1;

      focusTourItem(step.itemId);
    }

    function startTour() {
      tourActive = true;
      tourIndex = 0;
      updateTourUI();
    }

    function endTour() {
      tourActive = false;
      tourIndex = -1;
      clearTourHighlight();
      updateTourUI();
    }

    function nextTourStep() {
      if (!tourActive) {
        startTour();
        return;
      }
      if (tourIndex < TOUR_STEPS.length - 1) {
        tourIndex += 1;
        updateTourUI();
      }
    }

    function prevTourStep() {
      if (!tourActive) return;
      if (tourIndex > 0) {
        tourIndex -= 1;
        updateTourUI();
      }
    }

    function init() {
      renderChecklist();

      document.getElementById("uncertaintyGlobal").addEventListener("input", () => {
        updateUncertaintyLabel();
        updateDistributions();
      });
      updateUncertaintyLabel();
      updateDistributions();

      document.getElementById("exportButton").addEventListener("click", exportJson);

      document.getElementById("tourStartButton").addEventListener("click", startTour);
      document.getElementById("tourNext").addEventListener("click", nextTourStep);
      document.getElementById("tourPrev").addEventListener("click", prevTourStep);
      document.getElementById("tourEnd").addEventListener("click", endTour);

      updateTourUI();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
